{
    "componentChunkName": "component---src-templates-article-page-template-tsx",
    "path": "/posts/RocketMQ Rebalance流程",
    "result": {"pageContext":{"id":"/posts/RocketMQ Rebalance流程","htmlAst":{"type":"root","children":[{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"RocketMQ Rebalance流程"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"RocketMQ存在Rebalance机制，这个机制的作用是将一个Topic下的多个队列，在同一个消费者组下的多个consumer之间重新进行分配。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rebalance机制目的是为了提升消息的并行处理能力。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"假设不存在Rebalance机制，那就意味着原本有一个Consumer承载着Topic的8个队列，由于业务的增长无法用单个Consumer可以及时消费，这个时候没有Rebalance机制的存在导致即使增加了Consumer，也不会有任何改变。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Rebalance局限性"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"由于一个队列最多分配给一个消费者，因此当某个消费者组下的消费者实例大于队列数量时，多余的消费者将分配不到任何队列。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"消费暂停"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"考虑在只有"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 1"}]},{"type":"text","value":"的情况下，其负责消费所有4个队列;"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"在新增"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":"，触发"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"时，需要分配2个队列给其消费。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"那么"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 1"}]},{"type":"text","value":"就需要停止这2个队列的消费，等到这两个队列分配给"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":"后，这两个队列才能继续被消费。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"重复消费"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":" 在消费分配给自己的2个队列时，必须接着从"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 1"}]},{"type":"text","value":"之前已经消费到的offset继续开始消费。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"然而默认情况下，offset是异步提交的，如"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 1"}]},{"type":"text","value":"当前消费到offset为10，但是异步提交给broker的offset为8；"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"那么如果"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":"从8的offset开始消费，那么就会有2条消息重复。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"也就是说，"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":" 并不会等待"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer1"}]},{"type":"text","value":"提交完offset后，再进行"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"，因此提交间隔越长，可能造成的重复消费就越多。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"消费突刺"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"由于"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"可能导致重复消费，如果需要重复消费的消息过多；"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"或者因为"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"暂停时间过长，导致积压了部分消息。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"那么都有可能导致在"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"结束之后瞬间可能需要消费很多消息。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Rebalance分配规则"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"是没有做统一分配的，而是消费者通过自己再整体消费者中的偏移量来计算出自己应该获得哪些队列"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"分配算法需要实现下面这个接口:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"java","dataIndex":"0"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"/**"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" * Strategy Algorithm for message allocating between consumers"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" */"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"public"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"interface"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"AllocateMessageQueueStrategy"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" {"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"    /**"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * Allocating by consumer id"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     *"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@param"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"consumerGroup"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" current consumer group"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@param"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"currentCID"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" current consumer id"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@param"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" message queue set in current topic"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@param"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" consumer set in current consumer group"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" The allocate result of given strategy"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     */"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"MessageQueue"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"allocate"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"final"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"consumerGroup"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":","}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"final"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"currentCID"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":","}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"final"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"MessageQueue"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":","}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"final"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    );"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"    /**"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * Algorithm name"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     *"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" The strategy name"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     */"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"getName"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"();"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"这个接口的 getName() 只是一个唯一标识，用以标识该消费者实例是用什么负载均衡算法去分配队列。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"关键在于"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"allocate"}]},{"type":"text","value":"这个方法，这个方法的出参就是这次Rebalace的结果 —— 本消费者实例应该去获取的队列列表。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"其余四个入参分别是："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"消费者组名"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"当前的消费者实例的唯一ID，实际上就是client 的ip@instanceName。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"全局这个消费者组可以分配的队列集合"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"当前这个消费者组消费者集合（值是消费者实例的唯一id）"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"试想下，假设要你去做一个分配队列的算法，实际上最关键的就是两个视图："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"这个topic下全局当前在线的消费者列表"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"topic在全局下有哪些队列。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"例如，你知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，你就能知道每个消费者应该获取两个队列。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"例如： c1–>q0,q1, c2–>q2,q3, c3–>q4,q5, c4–>q5,q6。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"实际上，这就是rocketmq默认的分配方案。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"但现在唯一的问题在于，我们刚刚说的，我们没有一个中心节点统一地做分配，所以RocketMQ需要做一定的修改。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"如对于C1："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"“我是C1，我知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，我就能知道每个消费者应该获取两个队列，而我算出来我要的队列是c1–>q0,q1”。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"对于C2："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"“我是C2，我知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，我就能知道每个消费者应该获取两个队列，而我算出来我要的队列是c2–>q2,q3。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"要做到无中心的完成这个目标，唯一需要增加的输入项就是“我是C1”，”我是C2”这样的入参，所以上文提到的"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"allocate"}]},{"type":"text","value":"方法下面"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"当前的消费者实例"}]},{"type":"text","value":"的唯一ID就是干这个事用的。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"下面的代码就是RocketMQ的默认分配代码:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"java","dataIndex":"1"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"public"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<MessageQueue> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"allocate"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" consumerGroup, "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" currentCID, "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<MessageQueue> mqAll,"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<String> cidAll) {"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"MessageQueue"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"result"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"new"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"ArrayList"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"MessageQueue"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":">();"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"if"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" (!"}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"check"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(consumerGroup, currentCID, mqAll, cidAll)) {"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"            "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" result;"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        }"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"index"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"indexOf"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(currentCID);"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mod"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() % "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"();"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 求最大可分配个数"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// q数量不超过客户端的数量，则每个客户端最多分配一个queue"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 否则，每个客户端平分，当不够整除时，位置在mod内的按平均值多加1个，mod外的按平均值分"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"averageSize"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" ="}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"            "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() <= "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"?"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" (mod > "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" && index < mod "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"?"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() / "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"()"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"                + "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() / "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"());"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 计算当前客户端在queue列表的起始位置"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 如果能够整除，或者不够整除时位置在mod内，则直接移动分配到的最大个数移动自己索引的倍数，给其他的客户端留位置"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 如果不能整除且在mod外，则移动倍数之后加上mod数"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"startIndex"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = (mod > "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" && index < mod) "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"?"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" index * averageSize "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" index * averageSize + mod;"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 计算分配Q的个数，最后一组不足averageSize的只分配能分配到的个数"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"range"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"Math"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"min"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(averageSize, "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() - startIndex);"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 按照挪过的位置，计算所属Q的下标"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"for"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" ("}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"i"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"; i < range; i++) {"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"            "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"result"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"add"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"get"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"((startIndex + i) % "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"()));"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        }"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" result;"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    }"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"RocketMQ按照Topic维度进行Rebalance，会导致一个很严重的结果：如果一个消费者组订阅多个Topic，可能会出现分配不均，部分处于排序前列的分配更多的队列，部分消费者处于空闲状态。"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"由于订阅多个Topic时可能会出现分配不均，这是在RocketMQ中我们为什么不建议同一个消费者组订阅多个Topic的重要原因。在这一点上，Kafka与不RocketMQ同，其是将所有Topic下的所有队列合并在一起，进行Rebalance，因此相对会更加平均。"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"触发时机"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"RocketMQ有三个时机会触发："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"启动的时候，会立即触发"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"有消费实例数量的变更的时候。broker在接受到消费者的心跳包的时候如果发现这个实例是新的实例的时候，会广播一个消费者数量变更的事件给所有消费者实例；同理，当发现一个消费者实例的连接断了，也会广播这样的一个事件"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"定时触发（默认20秒）。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"由于Broker只会通知一次，不保证client一定会收到变更事件通知，需要通过定时触发避免"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"通知丢失"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"style","properties":{"className":["grvsc-styles"]},"children":[{"type":"text","value":"\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n"}]}],"data":{"quirksMode":false}},"html":"<h1 id=\"RocketMQ-Rebalance流程\">RocketMQ Rebalance流程</h1>\n<p updated=\"20220712103446\">RocketMQ存在Rebalance机制，这个机制的作用是将一个Topic下的多个队列，在同一个消费者组下的多个consumer之间重新进行分配。</p>\n<p updated=\"20220712103446\">Rebalance机制目的是为了提升消息的并行处理能力。</p>\n<p updated=\"20220712103446\">假设不存在Rebalance机制，那就意味着原本有一个Consumer承载着Topic的8个队列，由于业务的增长无法用单个Consumer可以及时消费，这个时候没有Rebalance机制的存在导致即使增加了Consumer，也不会有任何改变。</p>\n<h1 id=\"Rebalance局限性\">Rebalance局限性</h1>\n<ol updated=\"20220712103446\">\n<li id=\"20220712103446-fhugcvx\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">由于一个队列最多分配给一个消费者，因此当某个消费者组下的消费者实例大于队列数量时，多余的消费者将分配不到任何队列。</p>\n</li>\n<li id=\"20220712103446-hcn59dz\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">消费暂停</p>\n<p updated=\"20220712103446\">考虑在只有<em>Consumer 1</em>的情况下，其负责消费所有4个队列;</p>\n<p updated=\"20220712103446\">在新增<em>Consumer 2</em>，触发<code>Rebalance</code>时，需要分配2个队列给其消费。</p>\n<p updated=\"20220712103446\">那么<em>Consumer 1</em>就需要停止这2个队列的消费，等到这两个队列分配给<em>Consumer 2</em>后，这两个队列才能继续被消费。</p>\n</li>\n<li id=\"20220712103446-yzeokqf\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">重复消费</p>\n<p updated=\"20220712103446\"><em>Consumer 2</em> 在消费分配给自己的2个队列时，必须接着从<em>Consumer 1</em>之前已经消费到的offset继续开始消费。</p>\n<p updated=\"20220712103446\">然而默认情况下，offset是异步提交的，如<em>Consumer 1</em>当前消费到offset为10，但是异步提交给broker的offset为8；</p>\n<p updated=\"20220712103446\">那么如果<em>Consumer 2</em>从8的offset开始消费，那么就会有2条消息重复。</p>\n<p updated=\"20220712103446\">也就是说，<em>Consumer 2</em> 并不会等待<em>Consumer1</em>提交完offset后，再进行<code>Rebalance</code>，因此提交间隔越长，可能造成的重复消费就越多。</p>\n</li>\n<li id=\"20220712103446-jem068d\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">消费突刺</p>\n<p updated=\"20220712103446\">由于<code>Rebalance</code>可能导致重复消费，如果需要重复消费的消息过多；</p>\n<p updated=\"20220712103446\">或者因为<code>Rebalance</code>暂停时间过长，导致积压了部分消息。</p>\n<p updated=\"20220712103446\">那么都有可能导致在<code>Rebalance</code>结束之后瞬间可能需要消费很多消息。</p>\n</li>\n</ol>\n<h1 id=\"Rebalance分配规则\">Rebalance分配规则</h1>\n<p updated=\"20220712103446\"><code>Rebalance</code>是没有做统一分配的，而是消费者通过自己再整体消费者中的偏移量来计算出自己应该获得哪些队列</p>\n<p updated=\"20220712103446\">分配算法需要实现下面这个接口:</p>\n<pre class=\"code-block\" data-language=\"java\"><code class=\"hljs\">/**\n * Strategy Algorithm for message allocating between consumers\n */\npublic interface AllocateMessageQueueStrategy {\n\n    /**\n     * Allocating by consumer id\n     *\n     * @param consumerGroup current consumer group\n     * @param currentCID current consumer id\n     * @param mqAll message queue set in current topic\n     * @param cidAll consumer set in current consumer group\n     * @return The allocate result of given strategy\n     */\n    List&lt;MessageQueue&gt; allocate(\n        final String consumerGroup,\n        final String currentCID,\n        final List&lt;MessageQueue&gt; mqAll,\n        final List&lt;String&gt; cidAll\n    );\n\n    /**\n     * Algorithm name\n     *\n     * @return The strategy name\n     */\n    String getName();\n}\n</code></pre>\n<p updated=\"20220712103446\">这个接口的 getName() 只是一个唯一标识，用以标识该消费者实例是用什么负载均衡算法去分配队列。</p>\n<p updated=\"20220712103446\">关键在于<code>allocate</code>这个方法，这个方法的出参就是这次Rebalace的结果 —— 本消费者实例应该去获取的队列列表。</p>\n<p updated=\"20220712103446\">其余四个入参分别是：</p>\n<ol updated=\"20220712103446\">\n<li id=\"20220712103446-t41wl90\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">消费者组名</p>\n</li>\n<li id=\"20220712103446-8gjun7c\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">当前的消费者实例的唯一ID，实际上就是client 的ip@instanceName。</p>\n</li>\n<li id=\"20220712103446-3yxk87z\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">全局这个消费者组可以分配的队列集合</p>\n</li>\n<li id=\"20220712103446-ltltf9z\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">当前这个消费者组消费者集合（值是消费者实例的唯一id）</p>\n</li>\n</ol>\n<p updated=\"20220712103446\">试想下，假设要你去做一个分配队列的算法，实际上最关键的就是两个视图：</p>\n<ol updated=\"20220712103446\">\n<li id=\"20220712103446-m5opwx5\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">这个topic下全局当前在线的消费者列表</p>\n</li>\n<li id=\"20220712103446-7rxaioz\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">topic在全局下有哪些队列。</p>\n</li>\n</ol>\n<blockquote updated=\"20220712103446\">\n<p updated=\"20220712103446\">例如，你知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，你就能知道每个消费者应该获取两个队列。</p>\n<p updated=\"20220712103446\">例如： c1–&gt;q0,q1, c2–&gt;q2,q3, c3–&gt;q4,q5, c4–&gt;q5,q6。</p>\n</blockquote>\n<p updated=\"20220712103446\">实际上，这就是rocketmq默认的分配方案。</p>\n<p updated=\"20220712103446\">但现在唯一的问题在于，我们刚刚说的，我们没有一个中心节点统一地做分配，所以RocketMQ需要做一定的修改。</p>\n<ul updated=\"20220712103446\">\n<li id=\"20220712103446-e7p1sh0\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">如对于C1：</p>\n<p updated=\"20220712103446\">“我是C1，我知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，我就能知道每个消费者应该获取两个队列，而我算出来我要的队列是c1–&gt;q0,q1”。</p>\n</li>\n<li id=\"20220712103446-8fwwebs\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">对于C2：</p>\n<p updated=\"20220712103446\">“我是C2，我知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，我就能知道每个消费者应该获取两个队列，而我算出来我要的队列是c2–&gt;q2,q3。</p>\n</li>\n</ul>\n<p updated=\"20220712103446\">要做到无中心的完成这个目标，唯一需要增加的输入项就是“我是C1”，”我是C2”这样的入参，所以上文提到的<code>allocate</code>方法下面<code>当前的消费者实例</code>的唯一ID就是干这个事用的。</p>\n<p updated=\"20220712103446\">下面的代码就是RocketMQ的默认分配代码:</p>\n<pre class=\"code-block\" data-language=\"java\"><code class=\"hljs\">public List&lt;MessageQueue&gt; allocate(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,\n        List&lt;String&gt; cidAll) {\n\n        List&lt;MessageQueue&gt; result = new ArrayList&lt;MessageQueue&gt;();\n        if (!check(consumerGroup, currentCID, mqAll, cidAll)) {\n            return result;\n        }\n        int index = cidAll.indexOf(currentCID);\n        int mod = mqAll.size() % cidAll.size();\n        // 求最大可分配个数\n        // q数量不超过客户端的数量，则每个客户端最多分配一个queue\n        // 否则，每个客户端平分，当不够整除时，位置在mod内的按平均值多加1个，mod外的按平均值分\n        int averageSize =\n            mqAll.size() &lt;= cidAll.size() ? 1 : (mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()\n                + 1 : mqAll.size() / cidAll.size());\n        // 计算当前客户端在queue列表的起始位置\n        // 如果能够整除，或者不够整除时位置在mod内，则直接移动分配到的最大个数移动自己索引的倍数，给其他的客户端留位置\n        // 如果不能整除且在mod外，则移动倍数之后加上mod数\n        int startIndex = (mod &gt; 0 &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod;\n        // 计算分配Q的个数，最后一组不足averageSize的只分配能分配到的个数\n        int range = Math.min(averageSize, mqAll.size() - startIndex);\n        // 按照挪过的位置，计算所属Q的下标\n        for (int i = 0; i &lt; range; i++) {\n            result.add(mqAll.get((startIndex + i) % mqAll.size()));\n        }\n        return result;\n    }\n</code></pre>\n<p updated=\"20220712103446\"><strong>RocketMQ按照Topic维度进行Rebalance，会导致一个很严重的结果：如果一个消费者组订阅多个Topic，可能会出现分配不均，部分处于排序前列的分配更多的队列，部分消费者处于空闲状态。</strong></p>\n<p updated=\"20220712103446\"><strong>由于订阅多个Topic时可能会出现分配不均，这是在RocketMQ中我们为什么不建议同一个消费者组订阅多个Topic的重要原因。在这一点上，Kafka与不RocketMQ同，其是将所有Topic下的所有队列合并在一起，进行Rebalance，因此相对会更加平均。</strong></p>\n<h1 id=\"触发时机\">触发时机</h1>\n<p updated=\"20220712103446\">RocketMQ有三个时机会触发：</p>\n<ol updated=\"20220712103446\">\n<li id=\"20220712103446-infbm0x\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">启动的时候，会立即触发</p>\n</li>\n<li id=\"20220712103446-ekvt1f0\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">有消费实例数量的变更的时候。broker在接受到消费者的心跳包的时候如果发现这个实例是新的实例的时候，会广播一个消费者数量变更的事件给所有消费者实例；同理，当发现一个消费者实例的连接断了，也会广播这样的一个事件</p>\n</li>\n<li id=\"20220712103446-g8sk2wj\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">定时触发（默认20秒）。</p>\n<p updated=\"20220712103446\">由于Broker只会通知一次，不保证client一定会收到变更事件通知，需要通过定时触发避免<code>Rebalance</code>通知丢失</p>\n</li>\n</ol>\n","articleNode":{"field":{"contentType":"posts","topic":null},"frontmatter":{"id":"/posts/RocketMQ Rebalance流程","title":"RocketMQ Rebalance流程","date":"2022-05-11 17:06","absolute_path":"/posts/RocketMQ Rebalance流程"},"htmlAst":{"type":"root","children":[{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"RocketMQ Rebalance流程"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"RocketMQ存在Rebalance机制，这个机制的作用是将一个Topic下的多个队列，在同一个消费者组下的多个consumer之间重新进行分配。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Rebalance机制目的是为了提升消息的并行处理能力。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"假设不存在Rebalance机制，那就意味着原本有一个Consumer承载着Topic的8个队列，由于业务的增长无法用单个Consumer可以及时消费，这个时候没有Rebalance机制的存在导致即使增加了Consumer，也不会有任何改变。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Rebalance局限性"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"由于一个队列最多分配给一个消费者，因此当某个消费者组下的消费者实例大于队列数量时，多余的消费者将分配不到任何队列。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"消费暂停"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"考虑在只有"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 1"}]},{"type":"text","value":"的情况下，其负责消费所有4个队列;"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"在新增"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":"，触发"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"时，需要分配2个队列给其消费。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"那么"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 1"}]},{"type":"text","value":"就需要停止这2个队列的消费，等到这两个队列分配给"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":"后，这两个队列才能继续被消费。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"重复消费"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":" 在消费分配给自己的2个队列时，必须接着从"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 1"}]},{"type":"text","value":"之前已经消费到的offset继续开始消费。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"然而默认情况下，offset是异步提交的，如"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 1"}]},{"type":"text","value":"当前消费到offset为10，但是异步提交给broker的offset为8；"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"那么如果"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":"从8的offset开始消费，那么就会有2条消息重复。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"也就是说，"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer 2"}]},{"type":"text","value":" 并不会等待"},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"Consumer1"}]},{"type":"text","value":"提交完offset后，再进行"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"，因此提交间隔越长，可能造成的重复消费就越多。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"消费突刺"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"由于"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"可能导致重复消费，如果需要重复消费的消息过多；"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"或者因为"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"暂停时间过长，导致积压了部分消息。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"那么都有可能导致在"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"结束之后瞬间可能需要消费很多消息。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Rebalance分配规则"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"是没有做统一分配的，而是消费者通过自己再整体消费者中的偏移量来计算出自己应该获得哪些队列"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"分配算法需要实现下面这个接口:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"java","dataIndex":"0"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"/**"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" * Strategy Algorithm for message allocating between consumers"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" */"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"public"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"interface"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"AllocateMessageQueueStrategy"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" {"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"    /**"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * Allocating by consumer id"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     *"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@param"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"consumerGroup"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" current consumer group"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@param"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"currentCID"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" current consumer id"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@param"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" message queue set in current topic"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@param"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" consumer set in current consumer group"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" The allocate result of given strategy"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     */"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"MessageQueue"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"allocate"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"final"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"consumerGroup"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":","}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"final"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"currentCID"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":","}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"final"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"MessageQueue"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":","}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"final"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    );"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"    /**"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * Algorithm name"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     *"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     * "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"@return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":" The strategy name"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"     */"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"getName"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"();"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"这个接口的 getName() 只是一个唯一标识，用以标识该消费者实例是用什么负载均衡算法去分配队列。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"关键在于"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"allocate"}]},{"type":"text","value":"这个方法，这个方法的出参就是这次Rebalace的结果 —— 本消费者实例应该去获取的队列列表。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"其余四个入参分别是："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"消费者组名"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"当前的消费者实例的唯一ID，实际上就是client 的ip@instanceName。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"全局这个消费者组可以分配的队列集合"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"当前这个消费者组消费者集合（值是消费者实例的唯一id）"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"试想下，假设要你去做一个分配队列的算法，实际上最关键的就是两个视图："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"这个topic下全局当前在线的消费者列表"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"topic在全局下有哪些队列。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"例如，你知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，你就能知道每个消费者应该获取两个队列。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"例如： c1–>q0,q1, c2–>q2,q3, c3–>q4,q5, c4–>q5,q6。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"实际上，这就是rocketmq默认的分配方案。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"但现在唯一的问题在于，我们刚刚说的，我们没有一个中心节点统一地做分配，所以RocketMQ需要做一定的修改。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"如对于C1："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"“我是C1，我知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，我就能知道每个消费者应该获取两个队列，而我算出来我要的队列是c1–>q0,q1”。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"对于C2："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"“我是C2，我知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，我就能知道每个消费者应该获取两个队列，而我算出来我要的队列是c2–>q2,q3。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"要做到无中心的完成这个目标，唯一需要增加的输入项就是“我是C1”，”我是C2”这样的入参，所以上文提到的"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"allocate"}]},{"type":"text","value":"方法下面"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"当前的消费者实例"}]},{"type":"text","value":"的唯一ID就是干这个事用的。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"下面的代码就是RocketMQ的默认分配代码:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"java","dataIndex":"1"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"public"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<MessageQueue> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"allocate"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" consumerGroup, "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"String"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" currentCID, "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<MessageQueue> mqAll,"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<String> cidAll) {"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"List"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"MessageQueue"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"> "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"result"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"new"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"ArrayList"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"<"}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"MessageQueue"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":">();"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"if"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" (!"}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"check"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(consumerGroup, currentCID, mqAll, cidAll)) {"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"            "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" result;"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        }"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"index"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"indexOf"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(currentCID);"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mod"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() % "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"();"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 求最大可分配个数"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// q数量不超过客户端的数量，则每个客户端最多分配一个queue"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 否则，每个客户端平分，当不够整除时，位置在mod内的按平均值多加1个，mod外的按平均值分"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"averageSize"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" ="}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"            "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() <= "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"?"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" (mod > "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" && index < mod "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"?"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() / "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"()"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"                + "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() / "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"cidAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"());"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 计算当前客户端在queue列表的起始位置"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 如果能够整除，或者不够整除时位置在mod内，则直接移动分配到的最大个数移动自己索引的倍数，给其他的客户端留位置"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 如果不能整除且在mod外，则移动倍数之后加上mod数"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"startIndex"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = (mod > "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" && index < mod) "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"?"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" index * averageSize "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" index * averageSize + mod;"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 计算分配Q的个数，最后一组不足averageSize的只分配能分配到的个数"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"range"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"Math"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"min"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(averageSize, "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"() - startIndex);"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk3"]},"children":[{"type":"text","value":"// 按照挪过的位置，计算所属Q的下标"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"for"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" ("}]},{"type":"element","tagName":"span","properties":{"className":["mtk10"]},"children":[{"type":"text","value":"int"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"i"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"; i < range; i++) {"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"            "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"result"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"add"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"get"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"((startIndex + i) % "}]},{"type":"element","tagName":"span","properties":{"className":["mtk12"]},"children":[{"type":"text","value":"mqAll"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"size"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"()));"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        }"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"        "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" result;"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    }"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"RocketMQ按照Topic维度进行Rebalance，会导致一个很严重的结果：如果一个消费者组订阅多个Topic，可能会出现分配不均，部分处于排序前列的分配更多的队列，部分消费者处于空闲状态。"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"由于订阅多个Topic时可能会出现分配不均，这是在RocketMQ中我们为什么不建议同一个消费者组订阅多个Topic的重要原因。在这一点上，Kafka与不RocketMQ同，其是将所有Topic下的所有队列合并在一起，进行Rebalance，因此相对会更加平均。"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"触发时机"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"RocketMQ有三个时机会触发："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"启动的时候，会立即触发"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"有消费实例数量的变更的时候。broker在接受到消费者的心跳包的时候如果发现这个实例是新的实例的时候，会广播一个消费者数量变更的事件给所有消费者实例；同理，当发现一个消费者实例的连接断了，也会广播这样的一个事件"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"定时触发（默认20秒）。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"由于Broker只会通知一次，不保证client一定会收到变更事件通知，需要通过定时触发避免"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Rebalance"}]},{"type":"text","value":"通知丢失"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"style","properties":{"className":["grvsc-styles"]},"children":[{"type":"text","value":"\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n"}]}],"data":{"quirksMode":false}},"html":"<h1 id=\"RocketMQ-Rebalance流程\">RocketMQ Rebalance流程</h1>\n<p updated=\"20220712103446\">RocketMQ存在Rebalance机制，这个机制的作用是将一个Topic下的多个队列，在同一个消费者组下的多个consumer之间重新进行分配。</p>\n<p updated=\"20220712103446\">Rebalance机制目的是为了提升消息的并行处理能力。</p>\n<p updated=\"20220712103446\">假设不存在Rebalance机制，那就意味着原本有一个Consumer承载着Topic的8个队列，由于业务的增长无法用单个Consumer可以及时消费，这个时候没有Rebalance机制的存在导致即使增加了Consumer，也不会有任何改变。</p>\n<h1 id=\"Rebalance局限性\">Rebalance局限性</h1>\n<ol updated=\"20220712103446\">\n<li id=\"20220712103446-fhugcvx\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">由于一个队列最多分配给一个消费者，因此当某个消费者组下的消费者实例大于队列数量时，多余的消费者将分配不到任何队列。</p>\n</li>\n<li id=\"20220712103446-hcn59dz\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">消费暂停</p>\n<p updated=\"20220712103446\">考虑在只有<em>Consumer 1</em>的情况下，其负责消费所有4个队列;</p>\n<p updated=\"20220712103446\">在新增<em>Consumer 2</em>，触发<code>Rebalance</code>时，需要分配2个队列给其消费。</p>\n<p updated=\"20220712103446\">那么<em>Consumer 1</em>就需要停止这2个队列的消费，等到这两个队列分配给<em>Consumer 2</em>后，这两个队列才能继续被消费。</p>\n</li>\n<li id=\"20220712103446-yzeokqf\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">重复消费</p>\n<p updated=\"20220712103446\"><em>Consumer 2</em> 在消费分配给自己的2个队列时，必须接着从<em>Consumer 1</em>之前已经消费到的offset继续开始消费。</p>\n<p updated=\"20220712103446\">然而默认情况下，offset是异步提交的，如<em>Consumer 1</em>当前消费到offset为10，但是异步提交给broker的offset为8；</p>\n<p updated=\"20220712103446\">那么如果<em>Consumer 2</em>从8的offset开始消费，那么就会有2条消息重复。</p>\n<p updated=\"20220712103446\">也就是说，<em>Consumer 2</em> 并不会等待<em>Consumer1</em>提交完offset后，再进行<code>Rebalance</code>，因此提交间隔越长，可能造成的重复消费就越多。</p>\n</li>\n<li id=\"20220712103446-jem068d\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">消费突刺</p>\n<p updated=\"20220712103446\">由于<code>Rebalance</code>可能导致重复消费，如果需要重复消费的消息过多；</p>\n<p updated=\"20220712103446\">或者因为<code>Rebalance</code>暂停时间过长，导致积压了部分消息。</p>\n<p updated=\"20220712103446\">那么都有可能导致在<code>Rebalance</code>结束之后瞬间可能需要消费很多消息。</p>\n</li>\n</ol>\n<h1 id=\"Rebalance分配规则\">Rebalance分配规则</h1>\n<p updated=\"20220712103446\"><code>Rebalance</code>是没有做统一分配的，而是消费者通过自己再整体消费者中的偏移量来计算出自己应该获得哪些队列</p>\n<p updated=\"20220712103446\">分配算法需要实现下面这个接口:</p>\n<pre class=\"code-block\" data-language=\"java\"><code class=\"hljs\">/**\n * Strategy Algorithm for message allocating between consumers\n */\npublic interface AllocateMessageQueueStrategy {\n\n    /**\n     * Allocating by consumer id\n     *\n     * @param consumerGroup current consumer group\n     * @param currentCID current consumer id\n     * @param mqAll message queue set in current topic\n     * @param cidAll consumer set in current consumer group\n     * @return The allocate result of given strategy\n     */\n    List&lt;MessageQueue&gt; allocate(\n        final String consumerGroup,\n        final String currentCID,\n        final List&lt;MessageQueue&gt; mqAll,\n        final List&lt;String&gt; cidAll\n    );\n\n    /**\n     * Algorithm name\n     *\n     * @return The strategy name\n     */\n    String getName();\n}\n</code></pre>\n<p updated=\"20220712103446\">这个接口的 getName() 只是一个唯一标识，用以标识该消费者实例是用什么负载均衡算法去分配队列。</p>\n<p updated=\"20220712103446\">关键在于<code>allocate</code>这个方法，这个方法的出参就是这次Rebalace的结果 —— 本消费者实例应该去获取的队列列表。</p>\n<p updated=\"20220712103446\">其余四个入参分别是：</p>\n<ol updated=\"20220712103446\">\n<li id=\"20220712103446-t41wl90\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">消费者组名</p>\n</li>\n<li id=\"20220712103446-8gjun7c\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">当前的消费者实例的唯一ID，实际上就是client 的ip@instanceName。</p>\n</li>\n<li id=\"20220712103446-3yxk87z\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">全局这个消费者组可以分配的队列集合</p>\n</li>\n<li id=\"20220712103446-ltltf9z\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">当前这个消费者组消费者集合（值是消费者实例的唯一id）</p>\n</li>\n</ol>\n<p updated=\"20220712103446\">试想下，假设要你去做一个分配队列的算法，实际上最关键的就是两个视图：</p>\n<ol updated=\"20220712103446\">\n<li id=\"20220712103446-m5opwx5\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">这个topic下全局当前在线的消费者列表</p>\n</li>\n<li id=\"20220712103446-7rxaioz\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">topic在全局下有哪些队列。</p>\n</li>\n</ol>\n<blockquote updated=\"20220712103446\">\n<p updated=\"20220712103446\">例如，你知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，你就能知道每个消费者应该获取两个队列。</p>\n<p updated=\"20220712103446\">例如： c1–&gt;q0,q1, c2–&gt;q2,q3, c3–&gt;q4,q5, c4–&gt;q5,q6。</p>\n</blockquote>\n<p updated=\"20220712103446\">实际上，这就是rocketmq默认的分配方案。</p>\n<p updated=\"20220712103446\">但现在唯一的问题在于，我们刚刚说的，我们没有一个中心节点统一地做分配，所以RocketMQ需要做一定的修改。</p>\n<ul updated=\"20220712103446\">\n<li id=\"20220712103446-e7p1sh0\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">如对于C1：</p>\n<p updated=\"20220712103446\">“我是C1，我知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，我就能知道每个消费者应该获取两个队列，而我算出来我要的队列是c1–&gt;q0,q1”。</p>\n</li>\n<li id=\"20220712103446-8fwwebs\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">对于C2：</p>\n<p updated=\"20220712103446\">“我是C2，我知道当前有4个消费者 c1 c2 c3 c4在线，也知道topic 下有 8个队列 q0,q1,q2,q3,q4,…q6，那么8/4=2，我就能知道每个消费者应该获取两个队列，而我算出来我要的队列是c2–&gt;q2,q3。</p>\n</li>\n</ul>\n<p updated=\"20220712103446\">要做到无中心的完成这个目标，唯一需要增加的输入项就是“我是C1”，”我是C2”这样的入参，所以上文提到的<code>allocate</code>方法下面<code>当前的消费者实例</code>的唯一ID就是干这个事用的。</p>\n<p updated=\"20220712103446\">下面的代码就是RocketMQ的默认分配代码:</p>\n<pre class=\"code-block\" data-language=\"java\"><code class=\"hljs\">public List&lt;MessageQueue&gt; allocate(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,\n        List&lt;String&gt; cidAll) {\n\n        List&lt;MessageQueue&gt; result = new ArrayList&lt;MessageQueue&gt;();\n        if (!check(consumerGroup, currentCID, mqAll, cidAll)) {\n            return result;\n        }\n        int index = cidAll.indexOf(currentCID);\n        int mod = mqAll.size() % cidAll.size();\n        // 求最大可分配个数\n        // q数量不超过客户端的数量，则每个客户端最多分配一个queue\n        // 否则，每个客户端平分，当不够整除时，位置在mod内的按平均值多加1个，mod外的按平均值分\n        int averageSize =\n            mqAll.size() &lt;= cidAll.size() ? 1 : (mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()\n                + 1 : mqAll.size() / cidAll.size());\n        // 计算当前客户端在queue列表的起始位置\n        // 如果能够整除，或者不够整除时位置在mod内，则直接移动分配到的最大个数移动自己索引的倍数，给其他的客户端留位置\n        // 如果不能整除且在mod外，则移动倍数之后加上mod数\n        int startIndex = (mod &gt; 0 &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod;\n        // 计算分配Q的个数，最后一组不足averageSize的只分配能分配到的个数\n        int range = Math.min(averageSize, mqAll.size() - startIndex);\n        // 按照挪过的位置，计算所属Q的下标\n        for (int i = 0; i &lt; range; i++) {\n            result.add(mqAll.get((startIndex + i) % mqAll.size()));\n        }\n        return result;\n    }\n</code></pre>\n<p updated=\"20220712103446\"><strong>RocketMQ按照Topic维度进行Rebalance，会导致一个很严重的结果：如果一个消费者组订阅多个Topic，可能会出现分配不均，部分处于排序前列的分配更多的队列，部分消费者处于空闲状态。</strong></p>\n<p updated=\"20220712103446\"><strong>由于订阅多个Topic时可能会出现分配不均，这是在RocketMQ中我们为什么不建议同一个消费者组订阅多个Topic的重要原因。在这一点上，Kafka与不RocketMQ同，其是将所有Topic下的所有队列合并在一起，进行Rebalance，因此相对会更加平均。</strong></p>\n<h1 id=\"触发时机\">触发时机</h1>\n<p updated=\"20220712103446\">RocketMQ有三个时机会触发：</p>\n<ol updated=\"20220712103446\">\n<li id=\"20220712103446-infbm0x\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">启动的时候，会立即触发</p>\n</li>\n<li id=\"20220712103446-ekvt1f0\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">有消费实例数量的变更的时候。broker在接受到消费者的心跳包的时候如果发现这个实例是新的实例的时候，会广播一个消费者数量变更的事件给所有消费者实例；同理，当发现一个消费者实例的连接断了，也会广播这样的一个事件</p>\n</li>\n<li id=\"20220712103446-g8sk2wj\" updated=\"20220712103446\">\n<p updated=\"20220712103446\">定时触发（默认20秒）。</p>\n<p updated=\"20220712103446\">由于Broker只会通知一次，不保证client一定会收到变更事件通知，需要通过定时触发避免<code>Rebalance</code>通知丢失</p>\n</li>\n</ol>\n","headings":[{"depth":1,"value":"RocketMQ Rebalance流程"},{"depth":1,"value":"Rebalance局限性"},{"depth":1,"value":"Rebalance分配规则"},{"depth":1,"value":"触发时机"}],"path":"/posts/RocketMQ Rebalance流程"},"headings":[{"depth":1,"value":"RocketMQ Rebalance流程","slug":"rocketmq-rebalance流程"},{"depth":1,"value":"Rebalance局限性","slug":"rebalance局限性"},{"depth":1,"value":"Rebalance分配规则","slug":"rebalance分配规则"},{"depth":1,"value":"触发时机","slug":"触发时机"}]}},
    "staticQueryHashes": ["630634786","928362550"]}