{"componentChunkName":"component---src-templates-topic-post-template-js","path":"/topic/系统设计/样例/微博架构设计","result":{"data":{"siYuan":{"excerpt":"微博日活跃用户1.6亿+，每日访问量达百亿级，面对庞大用户群的海量访问，需要有良好的架构设计来支撑微博这庞大的访问量。 概述用例和约束 用例 用户发布了一条微博 服务将微博推送给关注者，并且进行手机推送 用户浏览自己的微博列表 用户浏览主页...","raw":"微博日活跃用户1.6亿+，每日访问量达百亿级，面对庞大用户群的海量访问，需要有良好的架构设计来支撑微博这庞大的访问量。\n\n# 概述用例和约束\n\n## 用例\n\n* **用户**发布了一条微博\n\n  **服务**将微博推送给关注者，并且进行手机推送\n* **用户**浏览自己的微博列表\n* **用户**浏览主页的微博列表（聚合关注的人的微博）\n* **用户**可以通过关键词搜索\n* **服务**应该具有高可用性\n\n## 限制条件与假设\n\n普遍情况\n\n* 网络流量不是均匀分布的\n* 发布微博的速度需要足够快速\n\n  * 除非有上百万的关注者，否则将微博推送给粉丝的速度要足够快\n* 1 亿个活跃用户\n* 每天新发布 5 亿条微博，每月新发布 150 亿条微博\n\n  * 平均每条微博需要推送给 5 个人\n  * 每天需要进行 50 亿次推送\n  * 每月需要进行 1500 亿次推送\n* 每月需要处理 2500 亿次读取请求\n* 每月需要处理 100 亿次搜索\n\n浏览功能\n\n* 浏览的速度需要足够快\n* 读取的负载远大于写入的负载\n\n搜索功能\n\n* 搜索的速度需要足够快\n\n* 搜索是高负载的读取功能\n\n计算用量\n\n* 每条微博的大小：\n\n  * `weibo_id` - 8 字节\n  * `user_id` - 32 字节\n  * `text` - 140 字节\n  * `media` - 平均 10 KB\n  * 总计： 大约 10 KB\n* 每月产生新微博的内容为 150 TB\n\n  * 每条微博 10 KB * 每天 5 亿条微博* 每月 30 天\n  * 3 年产生的内容为 5.4 PB\n* 每秒需要处理 10 万次读取请求\n\n  * 每个月需要处理 2500 亿次请求 * (每秒 400 次请求 / 每月 10 亿次请求)\n* 每秒发布 6000 条微博\n\n  * 每月发布 150 亿条微博 * (每秒 400 次请求 / 每月 10 次请求)\n* 每秒推送 6 万条微博\n\n  * 每月推送 1500 亿条微博 * (每秒 400 次请求 / 每月 10 亿次请求)\n* 每秒 4000 次搜索请求\n\n# 概要设计\n\n```mermaid\ngraph TD;\n\tClient-->WebServer;\n\tWebServer-->WriteAPI;\n\tWebServer-->ReadAPI;\n\tReadAPI-->TimeLineService;\n\tTimeLineService-->WeiboInfoService;\n\tTimeLineService-->UserInfoService;\n\tTimeLineService-->MemoryCache;\n\tWriteAPI-->FansService;\n\tFansService-->MemoryCache;\n\tFansService-->UserGraphService;\n\tFansService-->SearchService;\n\tSearchAPI-->SearchService;\n\tFansService-->NotificationService;\n\tWebServer-->SearchAPI;\n\tReadAPI-->MySQL;\n\tWriteAPI-->MySQL;\n\tFansService-->OSS;\n```\n\n# 设计核心组件\n\n## 用例: 用户发表了一篇微博\n\n我们可以简单的先将数据存储到MySQL中。\n\n查看当前用户的关注的人发的微博以及推送数据是非常麻烦的事情。\n\n根据预估容量，每秒大概会产生6万条数据，这个操作一般的关系型数据库可能会支撑不住，因此可以通过NoSQL数据库或者内存数据库来对数据进行存储。\n\n而且对于微博架构这种，大V发送了微博远比普通的用户发送的微博带来的影响大，会造成数据的倾斜。\n\n一般情况下处理这种情况下会采用推拉结合的模式来进行处理:\n\n* 推模式\n\n  如果用户被关注的人少，发送了微博，就直接将微博发送到各个人的收件箱中\n* 拉模式\n\n  如果用户被关注的人多，发送了微博就存储在自己的发件箱里，关注的人拉取自己的关注的人时在对关注的人的发件箱和自己的收件箱进行一个聚合\n\n处了数据模型，还需要对静态文件进行一个处理，可以借助于三方的对象存储来存储照片和视频之类的媒体文件。\n\n* **客户端**向应用反向代理的**Web 服务器**发送一条微博\n* **Web 服务器**将请求转发给**写 API**服务器\n* **写 API**服务器将微博使用 **SQL 数据库**存储于用户收件箱\n* **写 API**调用 **消息输出服务** ，进行以下操作：\n\n  * 查询**用户服务**找到存储于**内存缓存**中的此用户的粉丝\n  * 将微博存储于**内存缓存**中的**此用户的粉丝的主页TimeLine**中\n\n    * O(n) 复杂度操作： 1000 名粉丝 = 1000 次查找与插入\n  * 将微博数据存储在**搜索索引服务**中，以加快搜索\n  * 将媒体存储于**对象存储**中\n  * 使用**通知服务**向粉丝发送推送：\n\n    * 使用**队列**异步推送通知\n\n## 用例：用户浏览聚合主页时间轴\n\n* **客户端**向 **Web 服务器**发起一次读取主页的请求\n* **Web 服务器**将请求转发给**读取 API**服务器\n* **读取 API**服务器调用**TimeLine服务**进行以下操作：\n\n  * 从**内存缓存**读取时间轴数据，其中包括微博id 与用户 id - O(1)\n  * 通过 [multiget](http://redis.io/commands/mget) 向**微博信息服务**进行查询，以获取相关 id 微博的额外信息 - O(n)\n  * 通过 muiltiget 向**用户信息服务**进行查询，以获取相关 id 用户的额外信息 - O(n)\n\n## 用例：用户浏览用户时间轴\n\n* **客户端**向**Web 服务器**发起获得用户时间线的请求\n* **Web 服务器**将请求转发给**读取 API**服务器\n* **读取 API**从 **SQL 数据库**中取出用户的TimeLine\n\n## 用例：用户搜索关键词\n\n* **客户端**将搜索请求发给**Web 服务器**\n* **Web 服务器**将请求转发给**搜索 API**服务器\n* **搜索 API**调用**搜索服务**进行以下操作：\n\n  * 对输入进行转换与分词，弄明白需要搜索什么东西\n\n    * 移除标点等额外内容\n    * 将文本打散为词组\n    * 修正拼写错误\n    * 规范字母大小写\n    * 将查询转换为布尔操作\n  * 查询 **搜索集群** （例如Lucene、ES）检索结果：\n\n    * 对集群内的所有服务器进行查询，将有结果的查询进行聚合（Scatter gathers）\n    * 合并取到的条目，进行评分与排序，最终返回结果\n\n# 架构扩展\n\n**消息发送服务**有可能成为性能瓶颈。那些有着百万数量关注着的用户可能发一条微博就需要好几分钟才能完成消息的发送进程。这有可能使 @回复 这种微博时出现竞争条件，因此需要根据服务时间进行重排序来降低影响。\n\n我们还可以避免从高关注量的用户输出。相反，我们可以通过搜索来找到高关注量用户的微博，并将搜索结果与用户的主页时间轴合并，再根据时间对其进行排序。\n\n此外，还可以通过以下内容进行优化：\n\n* 仅为每个主页时间轴在**内存缓存**中存储数百条数据\n* 仅在**内存缓存**中存储活动用户的主页时间轴\n\n  * 如果某个用户在过去 30 天都没有产生活动，那我们可以使用 **SQL 数据库**重新构建他的时间轴\n\n    * 使用**用户服务**来查询并确定用户关注的人\n    * 从 **SQL 数据库**中取出推特，并将它们存入**内存缓存**\n* 仅在**微博信息服务**中存储一个月的推特\n* 仅在**用户信息服务**中存储活动用户的信息\n* **搜索集群**需要将推特保留在内存中，以降低延迟\n\n我们还可以考虑优化 **SQL 数据库** 来解决一些瓶颈问题。\n\n**内存缓存**能减小一些数据库的负载，靠 **SQL Read 副本**已经足够处理缓存未命中情况。我们还可以考虑使用一些额外的 SQL 性能拓展技术。\n\n高容量的写入将淹没单个的 **SQL 写主从**模式，因此需要更多的拓展技术。\n\n除此之外，还需要对热点事件造成的流量突增进行处理。可以采用容器化进行部署，流量或者负载达到一定程度就扩容。\n","html":"<div data-node-id=\"20220524140048-6qe9btx\" data-node-index=\"0\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524140531\"><div contenteditable=\"true\" spellcheck=\"false\">微博日活跃用户1.6亿+，每日访问量达百亿级，面对庞大用户群的海量访问，需要有良好的架构设计来支撑微博这庞大的访问量。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h1\" data-node-id=\"20220524140533-yb6pk63\" data-node-index=\"1\" data-type=\"NodeHeading\" class=\"h1\" updated=\"20220524140551\"><div contenteditable=\"true\" spellcheck=\"false\">概述用例和约束</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h2\" data-node-id=\"20220524140955-hl15d6z\" data-node-index=\"2\" data-type=\"NodeHeading\" class=\"h2\" updated=\"20220524140957\"><div contenteditable=\"true\" spellcheck=\"false\">用例</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524140958-kd34vrt\" data-node-index=\"3\" data-type=\"NodeList\" class=\"list\" updated=\"20220524141504\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524141234-9yamheu\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524141307\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524141234-33ofpia\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524141310\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>用户</strong>发布了一条微博</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524141243-jm8r8v0\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524141307\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>服务</strong>将微博推送给关注者，并且进行手机推送</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524141314-1wund0p\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524141338\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524141314-2ymr1k7\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524141338\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>用户</strong>浏览自己的微博列表</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524141338-di2b46h\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524141407\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524141338-pu852p6\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524141407\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>用户</strong>浏览主页的微博列表（聚合关注的人的微博）</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524141422-fnfuw4d\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524141448\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524141422-ysut1j7\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524141448\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>用户</strong>可以通过关键词搜索</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524141445-cwheq2a\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524141504\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524141445-p7uiid1\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524141504\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>服务</strong>应该具有高可用性</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h2\" data-node-id=\"20220524142056-m6nm6xm\" data-node-index=\"4\" data-type=\"NodeHeading\" class=\"h2\" updated=\"20220524142438\"><div contenteditable=\"true\" spellcheck=\"false\">限制条件与假设</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524142450-diorxm6\" data-node-index=\"5\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142450\"><div contenteditable=\"true\" spellcheck=\"false\">普遍情况</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142450-mg3o4pw\" data-node-index=\"6\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142507\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-3yarers\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142450\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-5pmk6f8\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142450\"><div contenteditable=\"true\" spellcheck=\"false\">网络流量不是均匀分布的</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-z22y419\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142459\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-27jaxko\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142456\"><div contenteditable=\"true\" spellcheck=\"false\">发布微博的速度需要足够快速</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142450-3z3r93n\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142459\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-hwtmzc2\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142459\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-p71q1hl\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142459\"><div contenteditable=\"true\" spellcheck=\"false\">除非有上百万的关注者，否则将微博推送给粉丝的速度要足够快</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-i5j44tq\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142450\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-hgb22wy\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142450\"><div contenteditable=\"true\" spellcheck=\"false\">1 亿个活跃用户</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-d46neeh\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142507\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-c7pocja\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142504\"><div contenteditable=\"true\" spellcheck=\"false\">每天新发布 5 亿条微博，每月新发布 150 亿条微博</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142450-i2szf96\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142507\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-5vcy8e5\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142507\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-ueee9z1\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142507\"><div contenteditable=\"true\" spellcheck=\"false\">平均每条微博需要推送给 5 个人</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-hx8ld8f\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142450\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-1s7lkec\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142450\"><div contenteditable=\"true\" spellcheck=\"false\">每天需要进行 50 亿次推送</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-u8o16p2\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142450\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-jshnz9b\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142450\"><div contenteditable=\"true\" spellcheck=\"false\">每月需要进行 1500 亿次推送</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-mpmqzct\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142450\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-s14kcvk\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142450\"><div contenteditable=\"true\" spellcheck=\"false\">每月需要处理 2500 亿次读取请求</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142450-ixsqq5y\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142450\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142450-ydbkfbw\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142450\"><div contenteditable=\"true\" spellcheck=\"false\">每月需要处理 100 亿次搜索</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524142510-m7gm87r\" data-node-index=\"7\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142519\"><div contenteditable=\"true\" spellcheck=\"false\">浏览功能</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142519-nys7yzm\" data-node-index=\"8\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142547\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142520-60j6tlz\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142535\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142520-46ubplk\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142535\"><div contenteditable=\"true\" spellcheck=\"false\">浏览的速度需要足够快</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142536-uvnegk1\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142547\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142536-gezqxz5\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142547\"><div contenteditable=\"true\" spellcheck=\"false\">读取的负载远大于写入的负载</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524142557-own5cud\" data-node-index=\"9\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142602\"><div contenteditable=\"true\" spellcheck=\"false\">搜索功能</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142603-qi572qb\" data-node-index=\"10\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142628\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142628-prdk6bc\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142628\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142628-0c81dq5\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142628\"><div contenteditable=\"true\" spellcheck=\"false\">搜索的速度需要足够快</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142611-lxfuloz\" data-node-index=\"11\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142630\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142630-hcqglzq\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142630\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142630-6z98tqi\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142630\"><div contenteditable=\"true\" spellcheck=\"false\">搜索是高负载的读取功能</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524142632-vz5pq63\" data-node-index=\"12\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142644\"><div contenteditable=\"true\" spellcheck=\"false\">计算用量</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142655-m8g48pq\" data-node-index=\"13\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142745\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-aqsdvhi\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142706\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-qwzpexf\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142706\"><div contenteditable=\"true\" spellcheck=\"false\">每条微博的大小：</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142655-k78ej2g\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142659\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-ecj96nc\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142659\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-flls4xz\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142659\"><div contenteditable=\"true\" spellcheck=\"false\"><code>weibo_id</code> - 8 字节</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-jf6dxx3\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142655\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-s2fjv8x\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142655\"><div contenteditable=\"true\" spellcheck=\"false\"><code>user_id</code> - 32 字节</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-987ec8k\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142655\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-u22jjnr\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142655\"><div contenteditable=\"true\" spellcheck=\"false\"><code>text</code> - 140 字节</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-qnmz1ke\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142655\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-uu834pg\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142655\"><div contenteditable=\"true\" spellcheck=\"false\"><code>media</code> - 平均 10 KB</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-ql5prcq\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142655\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-zt9ncwk\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142655\"><div contenteditable=\"true\" spellcheck=\"false\">总计： 大约 10 KB</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-x9asa0t\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142725\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-cokihit\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142712\"><div contenteditable=\"true\" spellcheck=\"false\">每月产生新微博的内容为 150 TB</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142655-erqydkc\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142725\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-kpa2hqh\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142722\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-k7iavg5\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142722\"><div contenteditable=\"true\" spellcheck=\"false\">每条微博 10 KB * 每天 5 亿条微博* 每月 30 天</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-ta2j1fx\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142725\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-7uj80cm\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142725\"><div contenteditable=\"true\" spellcheck=\"false\">3 年产生的内容为 5.4 PB</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-yzhbxjl\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142655\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-c6inu4o\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142655\"><div contenteditable=\"true\" spellcheck=\"false\">每秒需要处理 10 万次读取请求</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142655-3feu95x\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142655\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-p27mccw\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142655\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-f6ch8bc\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142655\"><div contenteditable=\"true\" spellcheck=\"false\">每个月需要处理 2500 亿次请求 * (每秒 400 次请求 / 每月 10 亿次请求)</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-bmew4fp\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142741\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-2xphuue\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142732\"><div contenteditable=\"true\" spellcheck=\"false\">每秒发布 6000 条微博</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142655-ffl5xe4\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142741\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-o46uxw0\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142741\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-gwlziyb\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142741\"><div contenteditable=\"true\" spellcheck=\"false\">每月发布 150 亿条微博 * (每秒 400 次请求 / 每月 10 次请求)</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-u25vw5o\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142745\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-hoitqa7\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142745\"><div contenteditable=\"true\" spellcheck=\"false\">每秒推送 6 万条微博</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524142655-l99mnjb\" data-type=\"NodeList\" class=\"list\" updated=\"20220524142743\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-5tbedim\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142743\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-cv060of\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142743\"><div contenteditable=\"true\" spellcheck=\"false\">每月推送 1500 亿条微博 * (每秒 400 次请求 / 每月 10 亿次请求)</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524142655-ts3p13z\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524142655\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524142655-qztb422\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524142655\"><div contenteditable=\"true\" spellcheck=\"false\">每秒 4000 次搜索请求</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h1\" data-node-id=\"20220524145303-hrsunb1\" data-node-index=\"14\" data-type=\"NodeHeading\" class=\"h1\" updated=\"20220524145437\"><div contenteditable=\"true\" spellcheck=\"false\">概要设计</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524145438-3qv8a45\" data-node-index=\"15\" data-type=\"NodeCodeBlock\" class=\"render-node\" updated=\"20220524154837\" data-content=\"graph TD;\n\tClient--&amp;gt;WebServer;\n\tWebServer--&amp;gt;WriteAPI;\n\tWebServer--&amp;gt;ReadAPI;\n\tReadAPI--&amp;gt;TimeLineService;\n\tTimeLineService--&amp;gt;WeiboInfoService;\n\tTimeLineService--&amp;gt;UserInfoService;\n\tTimeLineService--&amp;gt;MemoryCache;\n\tWriteAPI--&amp;gt;FansService;\n\tFansService--&amp;gt;MemoryCache;\n\tFansService--&amp;gt;UserGraphService;\n\tFansService--&amp;gt;SearchService;\n\tSearchAPI--&amp;gt;SearchService;\n\tFansService--&amp;gt;NotificationService;\n\tWebServer--&amp;gt;SearchAPI;\n\tReadAPI--&amp;gt;MySQL;\n\tWriteAPI--&amp;gt;MySQL;\n\tFansService--&amp;gt;OSS;\" data-subtype=\"mermaid\"><div spin=\"1\"></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h1\" data-node-id=\"20220524154837-c7lw852\" data-node-index=\"16\" data-type=\"NodeHeading\" class=\"h1\" updated=\"20220524155958\"><div contenteditable=\"true\" spellcheck=\"false\">设计核心组件</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h2\" data-node-id=\"20220524155958-ygnj4py\" data-node-index=\"17\" data-type=\"NodeHeading\" class=\"h2\" updated=\"20220524160011\"><div contenteditable=\"true\" spellcheck=\"false\">用例: 用户发表了一篇微博</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524160011-lksmmh8\" data-node-index=\"18\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524160216\"><div contenteditable=\"true\" spellcheck=\"false\">我们可以简单的先将数据存储到MySQL中。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524160217-3vy82sv\" data-node-index=\"19\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524160258\"><div contenteditable=\"true\" spellcheck=\"false\">查看当前用户的关注的人发的微博以及推送数据是非常麻烦的事情。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524160605-mjfxs0w\" data-node-index=\"20\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524160737\"><div contenteditable=\"true\" spellcheck=\"false\">根据预估容量，每秒大概会产生6万条数据，这个操作一般的关系型数据库可能会支撑不住，因此可以通过NoSQL数据库或者内存数据库来对数据进行存储。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524160738-5xgwhui\" data-node-index=\"21\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524161049\"><div contenteditable=\"true\" spellcheck=\"false\">而且对于微博架构这种，大V发送了微博远比普通的用户发送的微博带来的影响大，会造成数据的倾斜。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524161049-w5x3y47\" data-node-index=\"22\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524161106\"><div contenteditable=\"true\" spellcheck=\"false\">一般情况下处理这种情况下会采用推拉结合的模式来进行处理:</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524160807-gcrg0xd\" data-node-index=\"23\" data-type=\"NodeList\" class=\"list\" updated=\"20220524161753\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524160809-dt1m44u\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524161147\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524160809-t445p7u\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524160813\"><div contenteditable=\"true\" spellcheck=\"false\">推模式</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524160817-upg3lny\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524161147\"><div contenteditable=\"true\" spellcheck=\"false\">如果用户被关注的人少，发送了微博，就直接将微博发送到各个人的收件箱中</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524160813-q7llii5\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524161753\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524160813-vym5pck\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524160815\"><div contenteditable=\"true\" spellcheck=\"false\">拉模式</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524161150-fdmjfe4\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524161753\"><div contenteditable=\"true\" spellcheck=\"false\">如果用户被关注的人多，发送了微博就存储在自己的发件箱里，关注的人拉取自己的关注的人时在对关注的人的发件箱和自己的收件箱进行一个聚合</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524161757-5wcal07\" data-node-index=\"24\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524161924\"><div contenteditable=\"true\" spellcheck=\"false\">处了数据模型，还需要对静态文件进行一个处理，可以借助于三方的对象存储来存储照片和视频之类的媒体文件。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524163803-nz0f0iv\" data-node-index=\"25\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164201\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-olm7zj2\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164030\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-jhxoveu\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164030\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>客户端</strong>向应用反向代理的<strong>Web 服务器</strong>发送一条微博</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-plyk7bk\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524163803\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-wfeg3bt\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524163803\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>Web 服务器</strong>将请求转发给<strong>写 API</strong>服务器</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-xz0asaw\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164000\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-4hdraq9\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164000\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>写 API</strong>服务器将微博使用 <strong>SQL 数据库</strong>存储于用户收件箱</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-abxy21z\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164201\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-yjf5km8\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524163803\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>写 API</strong>调用 <strong>消息输出服务</strong> ，进行以下操作：</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524163803-nprvtvd\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164201\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-duu84rk\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524163813\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-azc0f9x\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524163813\"><div contenteditable=\"true\" spellcheck=\"false\">查询<strong>用户服务</strong>找到存储于<strong>内存缓存</strong>中的此用户的粉丝</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-x9w91wo\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164201\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-7y2ck6e\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164201\"><div contenteditable=\"true\" spellcheck=\"false\">将微博存储于<strong>内存缓存</strong>中的<strong>此用户的粉丝的主页TimeLine</strong>中</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524163803-a98n75m\" data-type=\"NodeList\" class=\"list\" updated=\"20220524163803\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-02a12ms\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524163803\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-n8mory3\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524163803\"><div contenteditable=\"true\" spellcheck=\"false\">O(n) 复杂度操作： 1000 名粉丝 = 1000 次查找与插入</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-w1wcqoj\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164040\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-w36me6y\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164040\"><div contenteditable=\"true\" spellcheck=\"false\">将微博数据存储在<strong>搜索索引服务</strong>中，以加快搜索</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-7vijvhc\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524163803\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-k864ed8\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524163803\"><div contenteditable=\"true\" spellcheck=\"false\">将媒体存储于<strong>对象存储</strong>中</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-k14so1w\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524163803\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-7cojlxr\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524163803\"><div contenteditable=\"true\" spellcheck=\"false\">使用<strong>通知服务</strong>向粉丝发送推送：</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524163803-inxb389\" data-type=\"NodeList\" class=\"list\" updated=\"20220524163803\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524163803-1lwwnin\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524163803\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524163803-ikmcijq\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524163803\"><div contenteditable=\"true\" spellcheck=\"false\">使用<strong>队列</strong>异步推送通知</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h2\" data-node-id=\"20220524163832-k1u2urx\" data-node-index=\"26\" data-type=\"NodeHeading\" class=\"h2\" updated=\"20220524164242\"><div contenteditable=\"true\" spellcheck=\"false\">用例：用户浏览聚合主页时间轴</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164132-i4tios8\" data-node-index=\"27\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164227\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164132-gzcwh4r\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164142\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164132-j8xjn7e\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164142\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>客户端</strong>向 <strong>Web 服务器</strong>发起一次读取主页的请求</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164132-uesdwdy\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164132\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164132-va5nypz\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164132\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>Web 服务器</strong>将请求转发给<strong>读取 API</strong>服务器</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164132-z3bg0q8\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164227\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164132-gtfynx0\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164153\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>读取 API</strong>服务器调用<strong>TimeLine服务</strong>进行以下操作：</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164132-ydjvqzm\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164227\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164132-x4mp26x\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164208\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164132-gxhm382\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164208\"><div contenteditable=\"true\" spellcheck=\"false\">从<strong>内存缓存</strong>读取时间轴数据，其中包括微博id 与用户 id - O(1)</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164132-bo5rmu9\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164227\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164132-vok4ki1\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164227\"><div contenteditable=\"true\" spellcheck=\"false\">通过 <span data-type=\"a\" data-href=\"http://redis.io/commands/mget\">multiget</span> 向<strong>微博信息服务</strong>进行查询，以获取相关 id 微博的额外信息 - O(n)</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164132-y09am25\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164222\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164132-sfvlgyt\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164222\"><div contenteditable=\"true\" spellcheck=\"false\">通过 muiltiget 向<strong>用户信息服务</strong>进行查询，以获取相关 id 用户的额外信息 - O(n)</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h2\" data-node-id=\"20220524164247-audibq3\" data-node-index=\"28\" data-type=\"NodeHeading\" class=\"h2\" updated=\"20220524164249\"><div contenteditable=\"true\" spellcheck=\"false\">用例：用户浏览用户时间轴</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164254-n3kpjzt\" data-node-index=\"29\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164301\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164254-slxcqcl\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164254\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164254-sb1marj\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164254\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>客户端</strong>向<strong>Web 服务器</strong>发起获得用户时间线的请求</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164254-sfuq18n\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164254\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164254-wy3drsj\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164254\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>Web 服务器</strong>将请求转发给<strong>读取 API</strong>服务器</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164254-0i7564l\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164301\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164254-j5rkufd\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164301\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>读取 API</strong>从 <strong>SQL 数据库</strong>中取出用户的TimeLine</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h2\" data-node-id=\"20220524164312-1obgv97\" data-node-index=\"30\" data-type=\"NodeHeading\" class=\"h2\" updated=\"20220524164317\"><div contenteditable=\"true\" spellcheck=\"false\">用例：用户搜索关键词</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164312-tvmrxhw\" data-node-index=\"31\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164338\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-auuwqhg\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164312\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-ayr64ud\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>客户端</strong>将搜索请求发给<strong>Web 服务器</strong></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-vu2zro5\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164312\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-z6p9pqo\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>Web 服务器</strong>将请求转发给<strong>搜索 API</strong>服务器</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-ckzqtsj\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164338\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-cogztzg\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>搜索 API</strong>调用<strong>搜索服务</strong>进行以下操作：</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164312-g197se8\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164338\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-23nygsh\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164312\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-77o1gi1\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\">对输入进行转换与分词，弄明白需要搜索什么东西</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164312-n7cttzu\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164312\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-rielwka\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164312\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-uhnmbg3\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\">移除标点等额外内容</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-7pxf67p\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164312\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-0pwa51l\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\">将文本打散为词组</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-l9mhyip\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164312\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-ef016sq\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\">修正拼写错误</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-0dqaags\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164312\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-ufw97zv\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\">规范字母大小写</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-n4wjaae\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164312\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-v46nlmx\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\">将查询转换为布尔操作</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-etalrgy\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164338\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-cj00muz\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164338\"><div contenteditable=\"true\" spellcheck=\"false\">查询 <strong>搜索集群</strong> （例如Lucene、ES）检索结果：</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164312-0ny5yvv\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164327\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-k4i0wec\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164327\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-xmziugc\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164327\"><div contenteditable=\"true\" spellcheck=\"false\">对集群内的所有服务器进行查询，将有结果的查询进行聚合（Scatter gathers）</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164312-kpt0aj1\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164312\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164312-7ya0vea\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164312\"><div contenteditable=\"true\" spellcheck=\"false\">合并取到的条目，进行评分与排序，最终返回结果</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"h1\" data-node-id=\"20220524164325-q9o9ung\" data-node-index=\"32\" data-type=\"NodeHeading\" class=\"h1\" updated=\"20220524164355\"><div contenteditable=\"true\" spellcheck=\"false\">架构扩展</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524164807-jjojpqy\" data-node-index=\"33\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164844\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>消息发送服务</strong>有可能成为性能瓶颈。那些有着百万数量关注着的用户可能发一条微博就需要好几分钟才能完成消息的发送进程。这有可能使 @回复 这种微博时出现竞争条件，因此需要根据服务时间进行重排序来降低影响。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524164807-fp53lt3\" data-node-index=\"34\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164900\"><div contenteditable=\"true\" spellcheck=\"false\">我们还可以避免从高关注量的用户输出。相反，我们可以通过搜索来找到高关注量用户的微博，并将搜索结果与用户的主页时间轴合并，再根据时间对其进行排序。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524164807-gfwerk5\" data-node-index=\"35\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164807\"><div contenteditable=\"true\" spellcheck=\"false\">此外，还可以通过以下内容进行优化：</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164807-38ybhyj\" data-node-index=\"36\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164919\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164807-yni082g\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164908\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164807-s51otes\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164908\"><div contenteditable=\"true\" spellcheck=\"false\">仅为每个主页时间轴在<strong>内存缓存</strong>中存储数百条数据</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164807-a5roxsf\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164914\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164807-h7b55hq\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164807\"><div contenteditable=\"true\" spellcheck=\"false\">仅在<strong>内存缓存</strong>中存储活动用户的主页时间轴</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164807-i0njyd9\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164914\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164807-3bccz77\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164914\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164807-b8vspoy\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164807\"><div contenteditable=\"true\" spellcheck=\"false\">如果某个用户在过去 30 天都没有产生活动，那我们可以使用 <strong>SQL 数据库</strong>重新构建他的时间轴</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-subtype=\"u\" data-node-id=\"20220524164807-0qi3e5a\" data-type=\"NodeList\" class=\"list\" updated=\"20220524164914\"><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164807-hjel77v\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164914\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164807-emgjakd\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164914\"><div contenteditable=\"true\" spellcheck=\"false\">使用<strong>用户服务</strong>来查询并确定用户关注的人</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164807-g2cf547\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164807\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164807-y88qhiq\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164807\"><div contenteditable=\"true\" spellcheck=\"false\">从 <strong>SQL 数据库</strong>中取出推特，并将它们存入<strong>内存缓存</strong></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164807-e06kiu5\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164919\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164807-l6psfer\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164919\"><div contenteditable=\"true\" spellcheck=\"false\">仅在<strong>微博信息服务</strong>中存储一个月的推特</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164807-1ufhoqc\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164807\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164807-ap5k3y9\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164807\"><div contenteditable=\"true\" spellcheck=\"false\">仅在<strong>用户信息服务</strong>中存储活动用户的信息</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-marker=\"*\" data-subtype=\"u\" data-node-id=\"20220524164807-rv74azr\" data-type=\"NodeListItem\" class=\"li\" updated=\"20220524164807\"><div class=\"protyle-action\" draggable=\"true\"><svg><use xlink:href=\"#iconDot\"></use></svg></div><div data-node-id=\"20220524164807-d28eyd9\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164807\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>搜索集群</strong>需要将推特保留在内存中，以降低延迟</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524164807-fchqbx7\" data-node-index=\"37\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164807\"><div contenteditable=\"true\" spellcheck=\"false\">我们还可以考虑优化 <strong>SQL 数据库</strong> 来解决一些瓶颈问题。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524164807-kfdo2kr\" data-node-index=\"38\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164807\"><div contenteditable=\"true\" spellcheck=\"false\"><strong>内存缓存</strong>能减小一些数据库的负载，靠 <strong>SQL Read 副本</strong>已经足够处理缓存未命中情况。我们还可以考虑使用一些额外的 SQL 性能拓展技术。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524164807-hnhm0ur\" data-node-index=\"39\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524164807\"><div contenteditable=\"true\" spellcheck=\"false\">高容量的写入将淹没单个的 <strong>SQL 写主从</strong>模式，因此需要更多的拓展技术。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div><div data-node-id=\"20220524164923-yt4o5pj\" data-node-index=\"40\" data-type=\"NodeParagraph\" class=\"p\" updated=\"20220524165324\"><div contenteditable=\"true\" spellcheck=\"false\">除此之外，还需要对热点事件造成的流量突增进行处理。可以采用容器化进行部署，流量或者负载达到一定程度就扩容。</div><div class=\"protyle-attr\" contenteditable=\"false\">​</div></div>","field":{"slug":"/topic/系统设计/样例/微博架构设计","topic":"系统设计"},"frontmatter":{"title":"微博架构设计","tags":["系统设计","样例"],"date":"2022-05-24","description":"微博日活跃用户1.6亿+，每日访问量达百亿级，面对庞大用户群的海量访问，需要有良好的架构设计来支撑微博这庞大的访问量。 概述用例和约束 用例 用户发布了一条微博 服务将微博推送给关注者，并且进行手机推送 用户浏览自己的微博列表 用户浏览主页..."}},"topic":{"title":"系统设计","tree":"{\"title\":\"系统设计\",\"id\":\"20220523142842-5ohvsi1\",\"parentId\":\"\",\"href\":\"/topic/系统设计\",\"path\":\"/topic/系统设计\",\"children\":[{\"title\":\"4S分析法\",\"id\":\"20220531175247-wjawyqd\",\"type\":\"d\",\"href\":\"/topic/系统设计/4S分析法\",\"parentId\":\"\",\"path\":\"/topic/系统设计/4S分析法\",\"parentPath\":\"/topic/系统设计\",\"sort\":2,\"children\":[{\"title\":\"Scenario场景\",\"id\":\"20220531175901-ev27fyc\",\"type\":\"d\",\"href\":\"/topic/系统设计/4S分析法/Scenario场景\",\"parentId\":\"\",\"path\":\"/topic/系统设计/4S分析法/Scenario场景\",\"parentPath\":\"/topic/系统设计/4S分析法\",\"children\":[{\"title\":\"需要设计哪些功能\",\"id\":\"20220531195141-ow2ml5e\",\"type\":\"h\",\"href\":\"/topic/系统设计/4S分析法/Scenario场景#需要设计哪些功能\",\"parentId\":\"20220531175901-ev27fyc\",\"path\":\"/topic/系统设计/4S分析法/Scenario场景\",\"parentPath\":\"/topic/系统设计/4S分析法\",\"children\":[],\"level\":3},{\"title\":\"需要承受的访问量\",\"id\":\"20220531203443-fb6pb36\",\"type\":\"h\",\"href\":\"/topic/系统设计/4S分析法/Scenario场景#需要承受的访问量\",\"parentId\":\"20220531175901-ev27fyc\",\"path\":\"/topic/系统设计/4S分析法/Scenario场景\",\"parentPath\":\"/topic/系统设计/4S分析法\",\"children\":[],\"level\":3}],\"level\":2}],\"level\":1},{\"title\":\"样例\",\"id\":\"20220523161014-1vkr1si\",\"type\":\"d\",\"href\":\"/topic/系统设计/样例\",\"parentId\":\"\",\"path\":\"/topic/系统设计/样例\",\"parentPath\":\"/topic/系统设计\",\"sort\":3,\"children\":[{\"title\":\"短链系统\",\"id\":\"20220523142856-tm0dduf\",\"type\":\"d\",\"href\":\"/topic/系统设计/样例/短链系统\",\"parentId\":\"\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"sort\":1,\"children\":[{\"title\":\"概述用例和约束\",\"id\":\"20220523152802-ora3luz\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#概述用例和约束\",\"parentId\":\"20220523142856-tm0dduf\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[{\"title\":\"用例\",\"id\":\"20220523153231-cqe7c6z\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#用例\",\"parentId\":\"20220523152802-ora3luz\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4},{\"title\":\"约束和假设\",\"id\":\"20220523153213-tyokdre\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#约束和假设\",\"parentId\":\"20220523152802-ora3luz\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4},{\"title\":\"预估容量\",\"id\":\"20220523153245-akx221a\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#预估容量\",\"parentId\":\"20220523152802-ora3luz\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4}],\"level\":3},{\"title\":\"创建一个高层次设计\",\"id\":\"20220523154027-n2m6mb0\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#创建一个高层次设计\",\"parentId\":\"20220523142856-tm0dduf\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":3},{\"title\":\"设计核心组件\",\"id\":\"20220523155756-as6zfq4\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#设计核心组件\",\"parentId\":\"20220523142856-tm0dduf\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[{\"title\":\"用例: 用户输入一段文本，然后得到一个随机生成的链接\",\"id\":\"20220523155920-i5awrmn\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#用例: 用户输入一段文本，然后得到一个随机生成的链接\",\"parentId\":\"20220523155756-as6zfq4\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4},{\"title\":\"用例：用户输入一个 paste 的 url 后可以看到它存储的内容\",\"id\":\"20220523160445-ppzjfcg\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#用例：用户输入一个 paste 的 url 后可以看到它存储的内容\",\"parentId\":\"20220523155756-as6zfq4\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4},{\"title\":\"用例： 服务跟踪分析页面\",\"id\":\"20220523160523-x0zwdli\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#用例： 服务跟踪分析页面\",\"parentId\":\"20220523155756-as6zfq4\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4},{\"title\":\"用例： 服务删除过期的 pastes\",\"id\":\"20220523160541-cln3fph\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#用例： 服务删除过期的 pastes\",\"parentId\":\"20220523155756-as6zfq4\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4}],\"level\":3},{\"title\":\"扩展设计\",\"id\":\"20220523160546-vbv6n9j\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#扩展设计\",\"parentId\":\"20220523142856-tm0dduf\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":3},{\"title\":\"总结\",\"id\":\"20220523163729-9u3wkrv\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/短链系统#总结\",\"parentId\":\"20220523142856-tm0dduf\",\"path\":\"/topic/系统设计/样例/短链系统\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":3}],\"level\":2},{\"title\":\"微博架构设计\",\"id\":\"20220524140048-zkiqvui\",\"type\":\"d\",\"href\":\"/topic/系统设计/样例/微博架构设计\",\"parentId\":\"\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"sort\":2,\"children\":[{\"title\":\"概述用例和约束\",\"id\":\"20220524140533-yb6pk63\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#概述用例和约束\",\"parentId\":\"20220524140048-zkiqvui\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[{\"title\":\"用例\",\"id\":\"20220524140955-hl15d6z\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#用例\",\"parentId\":\"20220524140533-yb6pk63\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4},{\"title\":\"限制条件与假设\",\"id\":\"20220524142056-m6nm6xm\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#限制条件与假设\",\"parentId\":\"20220524140533-yb6pk63\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4}],\"level\":3},{\"title\":\"概要设计\",\"id\":\"20220524145303-hrsunb1\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#概要设计\",\"parentId\":\"20220524140048-zkiqvui\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":3},{\"title\":\"设计核心组件\",\"id\":\"20220524154837-c7lw852\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#设计核心组件\",\"parentId\":\"20220524140048-zkiqvui\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[{\"title\":\"用例: 用户发表了一篇微博\",\"id\":\"20220524155958-ygnj4py\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#用例: 用户发表了一篇微博\",\"parentId\":\"20220524154837-c7lw852\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4},{\"title\":\"用例：用户浏览聚合主页时间轴\",\"id\":\"20220524163832-k1u2urx\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#用例：用户浏览聚合主页时间轴\",\"parentId\":\"20220524154837-c7lw852\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4},{\"title\":\"用例：用户浏览用户时间轴\",\"id\":\"20220524164247-audibq3\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#用例：用户浏览用户时间轴\",\"parentId\":\"20220524154837-c7lw852\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4},{\"title\":\"用例：用户搜索关键词\",\"id\":\"20220524164312-1obgv97\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#用例：用户搜索关键词\",\"parentId\":\"20220524154837-c7lw852\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":4}],\"level\":3},{\"title\":\"架构扩展\",\"id\":\"20220524164325-q9o9ung\",\"type\":\"h\",\"href\":\"/topic/系统设计/样例/微博架构设计#架构扩展\",\"parentId\":\"20220524140048-zkiqvui\",\"path\":\"/topic/系统设计/样例/微博架构设计\",\"parentPath\":\"/topic/系统设计/样例\",\"children\":[],\"level\":3}],\"level\":2}],\"level\":1},{\"title\":\"每个程序员都应该知道的延迟数字\",\"id\":\"20220524194105-29b5zns\",\"type\":\"d\",\"href\":\"/topic/系统设计/每个程序员都应该知道的延迟数字\",\"parentId\":\"\",\"path\":\"/topic/系统设计/每个程序员都应该知道的延迟数字\",\"parentPath\":\"/topic/系统设计\",\"sort\":4,\"children\":[],\"level\":1}],\"level\":0}"}},"pageContext":{"slug":"/topic/系统设计/样例/微博架构设计","topic":"系统设计"}},"staticQueryHashes":["1284643331","2841359383"]}