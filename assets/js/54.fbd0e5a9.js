(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{380:function(e,a,t){"use strict";t.r(a);var n=t(7),r=Object(n.a)({},(function(){var e=this,a=e._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"telegraph上传图片image-dimensions-invalid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#telegraph上传图片image-dimensions-invalid"}},[e._v("#")]),e._v(" Telegraph上传图片Image dimensions invalid")]),e._v(" "),a("p",[e._v("有的时候，使用API像"),a("code",[e._v("https://telegra.ph/upload")]),e._v("​上传文件的时候会抛出"),a("code",[e._v("Image dimensions invalid")]),e._v("​异常。")]),e._v(" "),a("p",[e._v("原因是Telegraph的图片限制：")]),e._v(" "),a("ul",[a("li",[e._v("图片尺寸小于10MB")]),e._v(" "),a("li",[e._v("宽高小于400的可能会产生异常")]),e._v(" "),a("li",[e._v("最大width 小于 5000，最大高度height 小于 4000")]),e._v(" "),a("li",[e._v("不接受webp类型的图片，所以需要转码")])]),e._v(" "),a("p",[e._v("因为是使用python代码进行上传，所以写了一段代码将尺寸修改到合适大小，并且对图片进行压缩；")]),e._v(" "),a("div",{staticClass:"language-pgsql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("def compress_img(image_content, max_size=800 * 1024):\n    save_quality = 60\n    query_sum = 0\n    image_content = BytesIO(image_content)\n    image = Image.open(image_content)\n    image_format = image.format\n    max_width = 5000\n    max_height = 4000\n    if image.width > max_width or image.height > max_height:\n        image = image.resize((max_width, max_height))\n    # 转成rgb才能保存为jpeg格式，PIL无法压缩png图片\n    image = image.convert('RGB')\n    while True:\n        img_byte_arr = BytesIO()\n        query_sum += 1\n        image.save(img_byte_arr, format=image_format, quality=save_quality)\n        pic_size_bytes = img_byte_arr.tell()\n        if pic_size_bytes <= max_size:\n            break\n        save_quality -= query_sum\n        if save_quality > 0:\n            continue\n        else:\n            break\n    img_byte_arr = img_byte_arr.getvalue()\n    return img_byte_arr\n\n\nasync def telegraph_file_upload(file_url):\n    '''\n    use file url upload to telegra.ph storage and returns its url\n    Works ONLY with 'gif', 'jpeg', 'jpg', 'png', 'mp4'\n\n    Parameters\n    ---------------\n    path_to_file -> str, file_url\n\n    Return\n    ---------------\n    telegraph_url -> str, url of the file uploaded\n    >>>telegraph_file_upload('https://pics4.baidu.com/feed/38dbb6fd5266d016a27113a55c317b0a34fa35ff.jpeg@f_auto?token=5ff5fe2c2e833b70692db8bae3a1f0ce')\n    https://telegra.ph/file/16016bafcf4eca0ce3e2b.jpg\n    >>>telegraph_file_upload('https://error.com')\n    error, txt-file can not be processed\n    '''\n    try:\n        response = await web.get(file_url)\n    except Exception as e:\n        logger.error(f'Error getting file: {file_url} {e}', exc_info=e)\n        return file_url\n    if response.status == 200:\n        image_data = response.content\n        url = 'https://telegra.ph/upload'\n        if response.headers.get('Content-Type') == 'image/webp':\n            from PIL import Image\n            image_data_png = Image.open(BytesIO(image_data)).convert('RGBA')\n            image_data_out = BytesIO()\n            image_data_png.save(image_data_out, format='png')\n            image_data = image_data_out.getvalue()\n            # 打印image_data的大小\n        image_data = compress_img(image_data)\n        upload_response = await web.post(url, data={'file': image_data})\n        import json\n        telegraph_url = json.loads(upload_response.content)\n        if 'error' in telegraph_url:\n            logger.error(f'Error uploading file: {file_url} {telegraph_url[\"error\"]}')\n            return file_url\n        telegraph_url = telegraph_url[0]['src']\n        telegraph_url = f'https://telegra.ph{telegraph_url}'\n        return telegraph_url\n    return file_url\n\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);