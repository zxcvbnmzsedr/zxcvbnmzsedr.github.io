(window.webpackJsonp=window.webpackJsonp||[]).push([[265],{529:function(t,s,a){"use strict";a.r(s);var r=a(7),e=Object(r.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"秒杀"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#秒杀"}},[t._v("#")]),t._v(" 秒杀")]),t._v(" "),s("blockquote",[s("p",[t._v("秒杀的三个特点:")]),t._v(" "),s("p",[t._v("整点开始")]),t._v(" "),s("p",[t._v("数量有限")]),t._v(" "),s("p",[t._v("售完截止")])]),t._v(" "),s("h1",{attrs:{id:"scenario场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scenario场景"}},[t._v("#")]),t._v(" Scenario场景")]),t._v(" "),s("p",[t._v("QPS预测:")]),t._v(" "),s("ol",[s("li",[t._v("平日每秒1K人访问该页面")]),t._v(" "),s("li",[t._v("秒杀每秒数十万人访问该页面")]),t._v(" "),s("li",[t._v("QPS增加100倍")])]),t._v(" "),s("p",[t._v("商品购买和下单流程:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image.ztianzeng.com/uPic/20220623165604.png",alt:""}})]),t._v(" "),s("p",[t._v("秒杀情况下最大的几个难点：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("瞬时大流量高并发")]),t._v(" "),s("p",[t._v("服务器、数据库承载的QPS有限，如数据库一般是1000QPS。要根据业务预估并发量，临时扩容")]),t._v(" "),s("p",[t._v("平常qps就大几百，秒杀情况下，并发量是数十倍")])]),t._v(" "),s("li",[s("p",[t._v("有限库存，不能超卖")]),t._v(" "),s("p",[t._v("需要精准控制库存量，保证数据一致性（面试热点）")])]),t._v(" "),s("li",[s("p",[t._v("恶意请求")]),t._v(" "),s("p",[t._v("脚本模拟购买，模拟几十万请求去抢购")])]),t._v(" "),s("li",[s("p",[t._v("固定时间开启")]),t._v(" "),s("p",[t._v("时间到了才能买，以为服务器时间为准，NTP同步？")])]),t._v(" "),s("li",[s("p",[t._v("严格限购")]),t._v(" "),s("p",[t._v("用户只能买1个或N个")])])]),t._v(" "),s("h2",{attrs:{id:"需求拆解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#需求拆解"}},[t._v("#")]),t._v(" 需求拆解")]),t._v(" "),s("p",[t._v("商家侧")]),t._v(" "),s("ul",[s("li",[t._v("新建秒杀活动")]),t._v(" "),s("li",[t._v("配置秒杀活动")])]),t._v(" "),s("p",[t._v("用户侧")]),t._v(" "),s("ul",[s("li",[t._v("商品秒杀页面")]),t._v(" "),s("li",[t._v("购买")]),t._v(" "),s("li",[t._v("下单")]),t._v(" "),s("li",[t._v("付款")])]),t._v(" "),s("h1",{attrs:{id:"service-服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service-服务"}},[t._v("#")]),t._v(" Service 服务")]),t._v(" "),s("p",[t._v("采用微服务架构来对系统进行开发，单独抽取秒杀模块以为防止雪崩。")]),t._v(" "),s("p",[t._v("关于单体架构和微服务的架构可以看"),s("a",{attrs:{href:"../../%E6%A6%82%E5%BF%B5"}},[t._v("这里")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image.ztianzeng.com/uPic/20220623171802.png",alt:""}})]),t._v(" "),s("h1",{attrs:{id:"storage存储"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#storage存储"}},[t._v("#")]),t._v(" Storage存储")]),t._v(" "),s("p",[t._v("数据如何存储和访问")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("为每个Service选择存储结构")])]),t._v(" "),s("li",[s("p",[t._v("细化表结构")])])]),t._v(" "),s("h3",{attrs:{id:"商品信息表-commodity-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#商品信息表-commodity-info"}},[t._v("#")]),t._v(" 商品信息表 commodity_info")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("商品ID")]),t._v(" "),s("th",[t._v("商品名称")]),t._v(" "),s("th",[t._v("商品描述")]),t._v(" "),s("th",[t._v("价格")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("id")]),t._v(" "),s("td",[t._v("name")]),t._v(" "),s("td",[t._v("desc")]),t._v(" "),s("td",[t._v("price"),s("br")])]),t._v(" "),s("tr",[s("td",[t._v("1")]),t._v(" "),s("td",[t._v("MBP"),s("br")]),t._v(" "),s("td",[t._v("好用")]),t._v(" "),s("td",[t._v("25000")])])])]),t._v(" "),s("h3",{attrs:{id:"秒杀活动表-seckill-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#秒杀活动表-seckill-info"}},[t._v("#")]),t._v(" 秒杀活动表 seckill_info")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("秒杀ID")]),t._v(" "),s("th",[t._v("秒杀名称")]),t._v(" "),s("th",[t._v("商品ID")]),t._v(" "),s("th",[t._v("价格")]),t._v(" "),s("th",[t._v("数量"),s("br")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("id")]),t._v(" "),s("td",[t._v("name")]),t._v(" "),s("td",[t._v("commodity_id")]),t._v(" "),s("td",[t._v("price")]),t._v(" "),s("td",[t._v("number")])]),t._v(" "),s("tr",[s("td",[t._v("1")]),t._v(" "),s("td",[t._v("MBP秒杀")]),t._v(" "),s("td",[t._v("1")]),t._v(" "),s("td",[t._v("20000")]),t._v(" "),s("td",[t._v("100")])])])]),t._v(" "),s("h3",{attrs:{id:"库存信息表-stock-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#库存信息表-stock-info"}},[t._v("#")]),t._v(" 库存信息表 stock_info")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("库存ID")]),t._v(" "),s("th",[t._v("商品ID")]),t._v(" "),s("th",[t._v("秒杀ID")]),t._v(" "),s("th",[t._v("库存")]),t._v(" "),s("th",[t._v("锁定"),s("br")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("id")]),t._v(" "),s("td",[t._v("commodity_id"),s("br")]),t._v(" "),s("td",[t._v("seckill_id")]),t._v(" "),s("td",[t._v("stock")]),t._v(" "),s("td",[t._v("lock")])]),t._v(" "),s("tr",[s("td",[t._v("1")]),t._v(" "),s("td",[t._v("189")]),t._v(" "),s("td",[t._v("0")]),t._v(" "),s("td",[t._v("10000")]),t._v(" "),s("td",[t._v("0")])]),t._v(" "),s("tr",[s("td",[t._v("2")]),t._v(" "),s("td",[t._v("189")]),t._v(" "),s("td",[t._v("1")]),t._v(" "),s("td",[t._v("100")]),t._v(" "),s("td",[t._v("5")])])])]),t._v(" "),s("h3",{attrs:{id:"订单信息表-order-info"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#订单信息表-order-info"}},[t._v("#")]),t._v(" 订单信息表 order_info")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("订单ID")]),t._v(" "),s("th",[t._v("商品ID")]),t._v(" "),s("th",[t._v("活动ID")]),t._v(" "),s("th",[t._v("用户ID")]),t._v(" "),s("th",[t._v("是否付款")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("id")]),t._v(" "),s("td",[t._v("commodity_id")]),t._v(" "),s("td",[t._v("seckill_id")]),t._v(" "),s("td",[t._v("user_id")]),t._v(" "),s("td",[t._v("is_pay")])]),t._v(" "),s("tr",[s("td",[t._v("1")]),t._v(" "),s("td",[t._v("1")]),t._v(" "),s("td",[t._v("1")]),t._v(" "),s("td",[t._v("tianzeng")]),t._v(" "),s("td",[t._v("1")])])])]),t._v(" "),s("h2",{attrs:{id:"数据流向"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据流向"}},[t._v("#")]),t._v(" 数据流向")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image.ztianzeng.com/uPic/20220624160023.png",alt:""}})]),t._v(" "),s("p",[t._v("秒杀操作:")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("查询库存余量")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" stock_info "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" commodity_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("and")]),t._v(" seckill_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("扣减库存")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("update")]),t._v(" stock_info "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" commodity_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("and")]),t._v(" seckill_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])])])]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("h1",{attrs:{id:"scala扩展设计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scala扩展设计"}},[t._v("#")]),t._v(" Scala扩展设计")]),t._v(" "),s("p",[t._v("秒杀本身是一个非常简单的服务，不简单的是可优化的点非常的多。")]),t._v(" "),s("h2",{attrs:{id:"数据一致性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据一致性"}},[t._v("#")]),t._v(" 数据一致性")]),t._v(" "),s("p",[t._v("我们上文直接采用MySQL，来应对查询，校验，扣减这一系列操作。但是这种粗暴的处理方式，在并发场景下会有超卖的问题。")]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("p",[t._v("假如有两个线程进来，在第一步的时候都查询了库存，都认为当前线程持有库存。")]),t._v(" "),s("p",[t._v("于是在扣减库存的时候，会把库存库存减少两次，会造成数据库中的数据和预期的不一致。")]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("p",[t._v("这种情况，我们可以开启事务进行处理, 在查询的时候使用for update 开启排他锁，以保证一个时间内，只有一个线程可以参与库存扣减")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 事务开始，会开启排它锁")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("start")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("transaction")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" stock_info "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" commodity_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("and")]),t._v(" seckill_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("update")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("update")]),t._v(" stock_info "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" commodity_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("and")]),t._v(" seckill_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("and")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("commit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("或者，使用乐观锁，只能够在库存数量大于0的的情况下，才能够执行库存的扣减")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" stock_info "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" commodity_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("and")]),t._v(" seckill_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("update")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("update")]),t._v(" stock_info "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" commodity_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("and")]),t._v(" seckill_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("and")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h2",{attrs:{id:"应对高qps"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#应对高qps"}},[t._v("#")]),t._v(" 应对高QPS")]),t._v(" "),s("p",[t._v("我们可以直接利用MySQL自己的特性去解决超卖问题，但是单纯的使用MySQL在并发量上来之后会直接导致MySQL崩溃。")]),t._v(" "),s("blockquote",[s("p",[t._v("MySQl的QPS单点1000QPS，秒杀场景下MySQL崩溃，且秒杀场景下大部分请求无效，无需下沉到MySQL。")])]),t._v(" "),s("p",[t._v("因此需要更加高效的中间件来做这部分服务，将无效的请求拦截到上游，我们可以采用Redis，单机Redis能达到 10万QPS。")]),t._v(" "),s("p",[t._v("将库存信息放到Redis中，在Redis中做库存的校验。在活动上线之前，在Redis中提前做库存的预热，查询、校验、扣减先在Redis中处理好之后，再丢到MySQL进行处理。")]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("p",[t._v("在活动开始之前，从数据库读取秒杀活动，然后用下面的命令将商品库存预热到redis中")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置秒杀ID为1，商品ID为1的库存数量，只有100个")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" seckill:"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(":commodity:"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(":stock "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("\n")])])]),s("p",[t._v("然后，在用户请求过来的时候，用Redis拦截大量无效请求，通过Redis扣减库存之后在下方到MySQL中")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image.ztianzeng.com/uPic/20220628132949.png",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"redis的缺陷优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#redis的缺陷优化"}},[t._v("#")]),t._v(" Redis的缺陷优化")]),t._v(" "),s("p",[t._v("并发量超高，同时数百万请求同时到达Redis的库存检测逻辑，Redis全部放行，这时候Redis基本无作用。")]),t._v(" "),s("p",[t._v("可以用Lua脚本将读取库存和库存扣减合并成一个操作来进行执行。")]),t._v(" "),s("div",{staticClass:"language-lua extra-class"},[s("pre",{pre:!0,attrs:{class:"language-lua"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" key"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" subNum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ARGV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" surplusStock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'get'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("surplusStock"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("elseif")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("subNum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" surplusStock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'incrby'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" KEYS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("subNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://image.ztianzeng.com/uPic/20220628134626.png",alt:""}})]),t._v(" "),s("p",[t._v("这种系统已经可以应对绝大多数的情况了")]),t._v(" "),s("h2",{attrs:{id:"这样就完美了吗"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#这样就完美了吗"}},[t._v("#")]),t._v(" 这样就完美了吗？")]),t._v(" "),s("p",[t._v("如果我们要秒杀的商品数据量在10W，这样下城到MySQL的量依旧非常巨大，无法承受。")]),t._v(" "),s("p",[t._v("所以在库存扣减之后，到MySQL的请求慢一点，可以通过MQ来进行削峰")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://image.ztianzeng.com/uPic/20220628135500.png",alt:""}})]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("h2",{attrs:{id:"分布式事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分布式事务"}},[t._v("#")]),t._v(" 分布式事务")]),t._v(" "),s("p",[t._v("由于采用的是微服务来进行开发，一个成功的订单需要历经各种服务。")]),t._v(" "),s("div",{staticClass:"language-mermaid extra-class"},[s("pre",{pre:!0,attrs:{class:"language-mermaid"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sequenceDiagram")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("participant")]),t._v(" 付款\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("participant")]),t._v(" 支付服务\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("participant")]),t._v(" 订单服务\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("participant")]),t._v(" 商品服务\n    付款"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("->>")]),t._v("支付服务"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("支付记录\n    支付服务"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("->>")]),t._v("订单服务"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("更新订单状态成功付款\n    订单服务"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("->>")]),t._v("商品服务"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("扣减库存\n")])])]),s("p",[t._v("所以需要分布式事务来对数据一致性，进行处理。关于分布式事务，看"),s("a",{attrs:{href:"/topic/%E5%88%86%E5%B8%83%E5%BC%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E6%95%B0%E6%8D%AE%E8%B0%83%E5%BA%A6/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E4%BA%8B%E5%8A%A1%E5%88%86%E7%B1%BB"}},[t._v("这里")])]),t._v(" "),s("h2",{attrs:{id:"其他的小细节"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他的小细节"}},[t._v("#")]),t._v(" 其他的小细节")]),t._v(" "),s("h3",{attrs:{id:"防止刷爆商品页面"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#防止刷爆商品页面"}},[t._v("#")]),t._v(" 防止刷爆商品页面")]),t._v(" "),s("p",[t._v("CDN -> 前端资源静态化")]),t._v(" "),s("h3",{attrs:{id:"服务高可用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务高可用"}},[t._v("#")]),t._v(" 服务高可用")]),t._v(" "),s("p",[t._v("尽量不要影响其他服务，尤其是非秒杀产品的正常购买。")]),t._v(" "),s("h3",{attrs:{id:"防止恶意刷请求或者爬虫请求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#防止恶意刷请求或者爬虫请求"}},[t._v("#")]),t._v(" 防止恶意刷请求或者爬虫请求")]),t._v(" "),s("p",[t._v("使用限流机制、验证码机制、或者接入三方风控等。")]),t._v(" "),s("p",[t._v("‍")]),t._v(" "),s("p",[t._v("‍")])])}),[],!1,null,null,null);s.default=e.exports}}]);