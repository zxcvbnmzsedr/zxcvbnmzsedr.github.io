{
    "componentChunkName": "component---src-templates-topic-page-template-tsx",
    "path": "/topic/系统设计/样例/秒杀",
    "result": {"pageContext":{"id":"/topic/系统设计/样例/秒杀","htmlAst":{"type":"root","children":[{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"秒杀的三个特点:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"整点开始"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"数量有限"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"售完截止"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Scenario场景"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　QPS预测:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"平日每秒1K人访问该页面"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"秒杀每秒数十万人访问该页面"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"QPS增加100倍"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　商品购买和下单流程:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220623165604.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　秒杀情况下最大的几个难点："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"瞬时大流量高并发"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"服务器、数据库承载的QPS有限，如数据库一般是1000QPS。要根据业务预估并发量，临时扩容"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"平常qps就大几百，秒杀情况下，并发量是数十倍"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"有限库存，不能超卖"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"需要精准控制库存量，保证数据一致性（面试热点）"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"恶意请求"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"脚本模拟购买，模拟几十万请求去抢购"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"固定时间开启"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"时间到了才能买，以为服务器时间为准，NTP同步？"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"严格限购"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"用户只能买1个或N个"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"需求拆解"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　商家侧"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"新建秒杀活动"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"配置秒杀活动"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　用户侧"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"商品秒杀页面"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"购买"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"下单"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"付款"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Service 服务"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　采用微服务架构来对系统进行开发，单独抽取秒杀模块以为防止雪崩。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　关于单体架构和微服务的架构可以看"},{"type":"element","tagName":"a","properties":{"href":"../../%E6%A6%82%E5%BF%B5"},"children":[{"type":"text","value":"这里"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220623171802.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Storage存储"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　数据如何存储和访问"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"为每个Service选择存储结构"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"细化表结构"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"商品信息表 commodity_info"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品名称"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品描述"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"价格"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"desc"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"price"},{"type":"element","tagName":"br","properties":{},"children":[]}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"MBP"},{"type":"element","tagName":"br","properties":{},"children":[]}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"好用"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"25000"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"秒杀活动表 seckill_info"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"秒杀ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"秒杀名称"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"价格"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"数量"},{"type":"element","tagName":"br","properties":{},"children":[]}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"commodity_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"price"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"number"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"MBP秒杀"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"20000"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"100"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"库存信息表 stock_info"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"库存ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"秒杀ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"库存"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"锁定"},{"type":"element","tagName":"br","properties":{},"children":[]}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"commodity_id"},{"type":"element","tagName":"br","properties":{},"children":[]}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"seckill_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"stock"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"lock"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"189"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"10000"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"0"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"189"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"100"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"5"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"订单信息表 order_info"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"订单ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"活动ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"用户ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"是否付款"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"commodity_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"seckill_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"user_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"is_pay"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"tianzeng"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"数据流向"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220624160023.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　秒杀操作:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"查询库存余量"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"0"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"select"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"from"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]}]}]}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"扣减库存"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"1"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"set"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock = stock - "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]}]}]}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Scala扩展设计"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　秒杀本身是一个非常简单的服务，不简单的是可优化的点非常的多。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"数据一致性"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　我们上文直接采用MySQL，来应对查询，校验，扣减这一系列操作。但是这种粗暴的处理方式，在并发场景下会有超卖的问题。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　假如有两个线程进来，在第一步的时候都查询了库存，都认为当前线程持有库存。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　于是在扣减库存的时候，会把库存库存减少两次，会造成数据库中的数据和预期的不一致。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　这种情况，我们可以开启事务进行处理, 在查询的时候使用for update 开启排他锁，以保证一个时间内，只有一个线程可以参与库存扣减"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"2"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"# 事务开始，会开启排它锁"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"start"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"transaction"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"select"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"from"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" for "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"set"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock = stock - "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"commit"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　或者，使用乐观锁，只能够在库存数量大于0的的情况下，才能够执行库存的扣减"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"3"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"select"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"from"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" for "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"set"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock = stock - "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock > "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"应对高QPS"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　我们可以直接利用MySQL自己的特性去解决超卖问题，但是单纯的使用MySQL在并发量上来之后会直接导致MySQL崩溃。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"MySQl的QPS单点1000QPS，秒杀场景下MySQL崩溃，且秒杀场景下大部分请求无效，无需下沉到MySQL。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　因此需要更加高效的中间件来做这部分服务，将无效的请求拦截到上游，我们可以采用Redis，单机Redis能达到 10万QPS。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　将库存信息放到Redis中，在Redis中做库存的校验。在活动上线之前，在Redis中提前做库存的预热，查询、校验、扣减先在Redis中处理好之后，再丢到MySQL进行处理。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　在活动开始之前，从数据库读取秒杀活动，然后用下面的命令将商品库存预热到redis中"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"4"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"# 设置秒杀ID为1，商品ID为1的库存数量，只有100个"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"SET"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill:"}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":":commodity:"}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":":stock "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"100"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　然后，在用户请求过来的时候，用Redis拦截大量无效请求，通过Redis扣减库存之后在下方到MySQL中"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220628132949.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Redis的缺陷优化"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　并发量超高，同时数百万请求同时到达Redis的库存检测逻辑，Redis全部放行，这时候Redis基本无作用。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　可以用Lua脚本将读取库存和库存扣减合并成一个操作来进行执行。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"lua","dataIndex":"5"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"local"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" key=KEYS["}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"];"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"local"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" subNum = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"tonumber"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(ARGV["}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"]) ;"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"local"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" surplusStock = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"tonumber"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(redis."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"call"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["mtk8"]},"children":[{"type":"text","value":"'get'"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":",key));"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"if"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" (surplusStock<="}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":") "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"then"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"elseif"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" (subNum > surplusStock) "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"then"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"  "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"else"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    redis."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"call"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["mtk8"]},"children":[{"type":"text","value":"'incrby'"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":", KEYS["}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"], -subNum)"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"2"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"end"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220628134626.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　这种系统已经可以应对绝大多数的情况了"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"这样就完美了吗？"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　如果我们要秒杀的商品数据量在10W，这样下城到MySQL的量依旧非常巨大，无法承受。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　所以在库存扣减之后，到MySQL的请求慢一点，可以通过MQ来进行削峰"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220628135500.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"分布式事务"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　由于采用的是微服务来进行开发，一个成功的订单需要历经各种服务。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["mermaid"],"dataProcessed":"true"},"children":[{"type":"element","tagName":"svg","properties":{"id":"mermaid-1658477524577","width":"100%","xmlns":"http://www.w3.org/2000/svg","height":"315","style":"max-width: 880px;","viewBox":"-50 -10 880 315"},"children":[{"type":"element","tagName":"style","properties":{},"children":[{"type":"text","value":"#mermaid-1658477524577 {font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1658477524577 .error-icon{fill:#552222;}#mermaid-1658477524577 .error-text{fill:#552222;stroke:#552222;}#mermaid-1658477524577 .edge-thickness-normal{stroke-width:2px;}#mermaid-1658477524577 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1658477524577 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1658477524577 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1658477524577 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1658477524577 .marker{fill:#333333;stroke:#333333;}#mermaid-1658477524577 .marker.cross{stroke:#333333;}#mermaid-1658477524577 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-1658477524577 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-1658477524577 text.actor>tspan{fill:black;stroke:none;}#mermaid-1658477524577 .actor-line{stroke:grey;}#mermaid-1658477524577 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-1658477524577 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-1658477524577 #arrowhead path{fill:#333;stroke:#333;}#mermaid-1658477524577 .sequenceNumber{fill:white;}#mermaid-1658477524577 #sequencenumber{fill:#333;}#mermaid-1658477524577 #crosshead path{fill:#333;stroke:#333;}#mermaid-1658477524577 .messageText{fill:#333;stroke:#333;}#mermaid-1658477524577 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-1658477524577 .labelText,#mermaid-1658477524577 .labelText>tspan{fill:black;stroke:none;}#mermaid-1658477524577 .loopText,#mermaid-1658477524577 .loopText>tspan{fill:black;stroke:none;}#mermaid-1658477524577 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-1658477524577 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-1658477524577 .noteText,#mermaid-1658477524577 .noteText>tspan{fill:black;stroke:none;}#mermaid-1658477524577 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-1658477524577 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-1658477524577 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-1658477524577 .actorPopupMenu{position:absolute;}#mermaid-1658477524577 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-1658477524577 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-1658477524577 .actor-man circle,#mermaid-1658477524577 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-1658477524577 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}"}]},{"type":"element","tagName":"g","properties":{},"children":[]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"symbol","properties":{"id":"computer","width":"24","height":"24"},"children":[{"type":"element","tagName":"path","properties":{"transform":"scale(.5)","d":"M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"symbol","properties":{"id":"database","fillRule":"evenodd","clipRule":"evenodd"},"children":[{"type":"element","tagName":"path","properties":{"transform":"scale(.5)","d":"M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"symbol","properties":{"id":"clock","width":"24","height":"24"},"children":[{"type":"element","tagName":"path","properties":{"transform":"scale(.5)","d":"M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z"},"children":[]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"line","properties":{"id":"actor0","x1":"75","y1":"5","x2":"75","y2":"249","className":["200"],"strokeWidth":"0.5px","stroke":"#999"},"children":[]},{"type":"element","tagName":"g","properties":{"id":"root-0"},"children":[{"type":"element","tagName":"rect","properties":{"x":"0","y":"0","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"75","y":"32.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"75","dy":"0"},"children":[{"type":"text","value":"付款"}]}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"line","properties":{"id":"actor1","x1":"275","y1":"5","x2":"275","y2":"249","className":["200"],"strokeWidth":"0.5px","stroke":"#999"},"children":[]},{"type":"element","tagName":"g","properties":{"id":"root-1"},"children":[{"type":"element","tagName":"rect","properties":{"x":"200","y":"0","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"275","y":"32.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"275","dy":"0"},"children":[{"type":"text","value":"支付服务"}]}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"line","properties":{"id":"actor2","x1":"505","y1":"5","x2":"505","y2":"249","className":["200"],"strokeWidth":"0.5px","stroke":"#999"},"children":[]},{"type":"element","tagName":"g","properties":{"id":"root-2"},"children":[{"type":"element","tagName":"rect","properties":{"x":"430","y":"0","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"505","y":"32.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"505","dy":"0"},"children":[{"type":"text","value":"订单服务"}]}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"line","properties":{"id":"actor3","x1":"705","y1":"5","x2":"705","y2":"249","className":["200"],"strokeWidth":"0.5px","stroke":"#999"},"children":[]},{"type":"element","tagName":"g","properties":{"id":"root-3"},"children":[{"type":"element","tagName":"rect","properties":{"x":"630","y":"0","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"705","y":"32.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"705","dy":"0"},"children":[{"type":"text","value":"商品服务"}]}]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"marker","properties":{"id":"arrowhead","refX":"9","refY":"5","markerUnits":"userSpaceOnUse","markerWidth":"12","markerHeight":"12","orient":"auto"},"children":[{"type":"element","tagName":"path","properties":{"d":"M 0 0 L 10 5 L 0 10 z"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"marker","properties":{"id":"crosshead","markerWidth":"15","markerHeight":"8","orient":"auto","refX":"16","refY":"4"},"children":[{"type":"element","tagName":"path","properties":{"fill":"black","stroke":"#000000","strokeWidth":"1px","d":"M 9,2 V 6 L16,4 Z","style":"stroke-dasharray: 0, 0;"},"children":[]},{"type":"element","tagName":"path","properties":{"fill":"none","stroke":"#000000","strokeWidth":"1px","d":"M 0,1 L 6,7 M 6,1 L 0,7","style":"stroke-dasharray: 0, 0;"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"marker","properties":{"id":"filled-head","refX":"18","refY":"7","markerWidth":"20","markerHeight":"28","orient":"auto"},"children":[{"type":"element","tagName":"path","properties":{"d":"M 18,7 L9,13 L14,7 L9,1 Z"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"marker","properties":{"id":"sequencenumber","refX":"15","refY":"15","markerWidth":"60","markerHeight":"40","orient":"auto"},"children":[{"type":"element","tagName":"circle","properties":{"cx":"15","cy":"15","r":"6"},"children":[]}]}]},{"type":"element","tagName":"text","properties":{"x":"175","y":"80","textAnchor":"middle","dominantBaseline":"middle","alignmentBaseline":"middle","className":["messageText"],"dy":"1em","style":"font-family: \"trebuchet ms\", verdana, arial, sans-serif; font-size: 16px; font-weight: 400;"},"children":[{"type":"text","value":"支付记录"}]},{"type":"element","tagName":"line","properties":{"x1":"75","y1":"113","x2":"275","y2":"113","className":["messageLine0"],"strokeWidth":"2","stroke":"none","markerEnd":"url(#arrowhead)","style":"fill: none;"},"children":[]},{"type":"element","tagName":"text","properties":{"x":"390","y":"128","textAnchor":"middle","dominantBaseline":"middle","alignmentBaseline":"middle","className":["messageText"],"dy":"1em","style":"font-family: \"trebuchet ms\", verdana, arial, sans-serif; font-size: 16px; font-weight: 400;"},"children":[{"type":"text","value":"更新订单状态成功付款"}]},{"type":"element","tagName":"line","properties":{"x1":"275","y1":"161","x2":"505","y2":"161","className":["messageLine0"],"strokeWidth":"2","stroke":"none","markerEnd":"url(#arrowhead)","style":"fill: none;"},"children":[]},{"type":"element","tagName":"text","properties":{"x":"605","y":"176","textAnchor":"middle","dominantBaseline":"middle","alignmentBaseline":"middle","className":["messageText"],"dy":"1em","style":"font-family: \"trebuchet ms\", verdana, arial, sans-serif; font-size: 16px; font-weight: 400;"},"children":[{"type":"text","value":"扣减库存"}]},{"type":"element","tagName":"line","properties":{"x1":"505","y1":"209","x2":"705","y2":"209","className":["messageLine0"],"strokeWidth":"2","stroke":"none","markerEnd":"url(#arrowhead)","style":"fill: none;"},"children":[]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"rect","properties":{"x":"0","y":"229","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"75","y":"261.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"75","dy":"0"},"children":[{"type":"text","value":"付款"}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"rect","properties":{"x":"200","y":"229","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"275","y":"261.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"275","dy":"0"},"children":[{"type":"text","value":"支付服务"}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"rect","properties":{"x":"430","y":"229","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"505","y":"261.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"505","dy":"0"},"children":[{"type":"text","value":"订单服务"}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"rect","properties":{"x":"630","y":"229","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"705","y":"261.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"705","dy":"0"},"children":[{"type":"text","value":"商品服务"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　所以需要分布式事务来对数据一致性，进行处理。关于分布式事务，看"},{"type":"element","tagName":"a","properties":{"href":"/topic/%E5%88%86%E5%B8%83%E5%BC%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E6%95%B0%E6%8D%AE%E8%B0%83%E5%BA%A6/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E4%BA%8B%E5%8A%A1%E5%88%86%E7%B1%BB"},"children":[{"type":"text","value":"这里"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"其他的小细节"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"防止刷爆商品页面"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　CDN -> 前端资源静态化"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"服务高可用"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　尽量不要影响其他服务，尤其是非秒杀产品的正常购买。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"防止恶意刷请求或者爬虫请求"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　使用限流机制、验证码机制、或者接入三方风控等。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"style","properties":{"className":["grvsc-styles"]},"children":[{"type":"text","value":"\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n"}]}],"data":{"quirksMode":false}},"html":"<blockquote updated=\"20220722161128\">\n<p updated=\"20220722161128\">秒杀的三个特点:</p>\n<p updated=\"20220722161128\">整点开始</p>\n<p updated=\"20220722161128\">数量有限</p>\n<p updated=\"20220722161128\">售完截止</p>\n</blockquote>\n<h1 id=\"Scenario场景\">Scenario场景</h1>\n<p updated=\"20220722161128\">　　QPS预测:</p>\n<ol updated=\"20220722161128\">\n<li id=\"20220722161128-7klqam4\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">平日每秒1K人访问该页面</p>\n</li>\n<li id=\"20220722161128-f45s06a\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">秒杀每秒数十万人访问该页面</p>\n</li>\n<li id=\"20220722161128-qrgev64\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">QPS增加100倍</p>\n</li>\n</ol>\n<p updated=\"20220722161128\">　　商品购买和下单流程:</p>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220623165604.png\" alt=\"\" /></span></p>\n<p updated=\"20220722161128\">　　秒杀情况下最大的几个难点：</p>\n<ol updated=\"20220722161128\">\n<li id=\"20220722161128-9lrynw1\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">瞬时大流量高并发</p>\n<p updated=\"20220722161128\">服务器、数据库承载的QPS有限，如数据库一般是1000QPS。要根据业务预估并发量，临时扩容</p>\n<p updated=\"20220722161128\">平常qps就大几百，秒杀情况下，并发量是数十倍</p>\n</li>\n<li id=\"20220722161128-c3md19l\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">有限库存，不能超卖</p>\n<p updated=\"20220722161128\">需要精准控制库存量，保证数据一致性（面试热点）</p>\n</li>\n<li id=\"20220722161128-bur6wc7\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">恶意请求</p>\n<p updated=\"20220722161128\">脚本模拟购买，模拟几十万请求去抢购</p>\n</li>\n<li id=\"20220722161128-8lru67i\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">固定时间开启</p>\n<p updated=\"20220722161128\">时间到了才能买，以为服务器时间为准，NTP同步？</p>\n</li>\n<li id=\"20220722161128-x29fyp5\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">严格限购</p>\n<p updated=\"20220722161128\">用户只能买1个或N个</p>\n</li>\n</ol>\n<h2 id=\"需求拆解\">需求拆解</h2>\n<p updated=\"20220722161128\">　　商家侧</p>\n<ul updated=\"20220722161128\">\n<li id=\"20220722161128-el1zld7\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">新建秒杀活动</p>\n</li>\n<li id=\"20220722161128-usb4ut7\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">配置秒杀活动</p>\n</li>\n</ul>\n<p updated=\"20220722161128\">　　用户侧</p>\n<ul updated=\"20220722161128\">\n<li id=\"20220722161128-480irts\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">商品秒杀页面</p>\n</li>\n<li id=\"20220722161128-qf6p6p0\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">购买</p>\n</li>\n<li id=\"20220722161128-3hswpt2\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">下单</p>\n</li>\n<li id=\"20220722161128-of9tth0\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">付款</p>\n</li>\n</ul>\n<h1 id=\"Service-服务\">Service 服务</h1>\n<p updated=\"20220722161128\">　　采用微服务架构来对系统进行开发，单独抽取秒杀模块以为防止雪崩。</p>\n<p updated=\"20220722161128\">　　关于单体架构和微服务的架构可以看<a href=\"../../概念\">这里</a></p>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220623171802.png\" alt=\"\" /></span></p>\n<h1 id=\"Storage存储\">Storage存储</h1>\n<p updated=\"20220722161128\">　　数据如何存储和访问</p>\n<ol updated=\"20220722161128\">\n<li id=\"20220722161128-intijhm\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">为每个Service选择存储结构</p>\n</li>\n<li id=\"20220722161128-w64vmzl\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">细化表结构</p>\n</li>\n</ol>\n<h3 id=\"商品信息表-commodity-info\">商品信息表 commodity_info</h3>\n<table updated=\"20220722161128\">\n<thead>\n<tr>\n<th>商品ID</th>\n<th>商品名称</th>\n<th>商品描述</th>\n<th>价格</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>name</td>\n<td>desc</td>\n<td>price<br /></td>\n</tr>\n<tr>\n<td>1</td>\n<td>MBP<br /></td>\n<td>好用</td>\n<td>25000</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"秒杀活动表-seckill-info\">秒杀活动表 seckill_info</h3>\n<table updated=\"20220722161128\">\n<thead>\n<tr>\n<th>秒杀ID</th>\n<th>秒杀名称</th>\n<th>商品ID</th>\n<th>价格</th>\n<th>数量<br /></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>name</td>\n<td>commodity_id</td>\n<td>price</td>\n<td>number</td>\n</tr>\n<tr>\n<td>1</td>\n<td>MBP秒杀</td>\n<td>1</td>\n<td>20000</td>\n<td>100</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"库存信息表-stock-info\">库存信息表 stock_info</h3>\n<table updated=\"20220722161128\">\n<thead>\n<tr>\n<th>库存ID</th>\n<th>商品ID</th>\n<th>秒杀ID</th>\n<th>库存</th>\n<th>锁定<br /></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>commodity_id<br /></td>\n<td>seckill_id</td>\n<td>stock</td>\n<td>lock</td>\n</tr>\n<tr>\n<td>1</td>\n<td>189</td>\n<td>0</td>\n<td>10000</td>\n<td>0</td>\n</tr>\n<tr>\n<td>2</td>\n<td>189</td>\n<td>1</td>\n<td>100</td>\n<td>5</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"订单信息表-order-info\">订单信息表 order_info</h3>\n<table updated=\"20220722161128\">\n<thead>\n<tr>\n<th>订单ID</th>\n<th>商品ID</th>\n<th>活动ID</th>\n<th>用户ID</th>\n<th>是否付款</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>commodity_id</td>\n<td>seckill_id</td>\n<td>user_id</td>\n<td>is_pay</td>\n</tr>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>1</td>\n<td>tianzeng</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"数据流向\">数据流向</h2>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220624160023.png\" alt=\"\" /></span></p>\n<p updated=\"20220722161128\">　　秒杀操作:</p>\n<ol updated=\"20220722161128\">\n<li id=\"20220722161128-bzmdwm3\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">查询库存余量</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\">select stock from stock_info where commodity_id = 1 and seckill_id = 1\n</code></pre></li>\n<li id=\"20220722161128-7xzd8py\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">扣减库存</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\">update stock_info set stock = stock - 1 where commodity_id = 1 and seckill_id = 1\n</code></pre></li>\n</ol>\n<h1 id=\"Scala扩展设计\">Scala扩展设计</h1>\n<p updated=\"20220722161128\">　　秒杀本身是一个非常简单的服务，不简单的是可优化的点非常的多。</p>\n<h2 id=\"数据一致性\">数据一致性</h2>\n<p updated=\"20220722161128\">　　我们上文直接采用MySQL，来应对查询，校验，扣减这一系列操作。但是这种粗暴的处理方式，在并发场景下会有超卖的问题。</p>\n<p updated=\"20220722161128\">　　假如有两个线程进来，在第一步的时候都查询了库存，都认为当前线程持有库存。</p>\n<p updated=\"20220722161128\">　　于是在扣减库存的时候，会把库存库存减少两次，会造成数据库中的数据和预期的不一致。</p>\n<p updated=\"20220722161128\">　　这种情况，我们可以开启事务进行处理, 在查询的时候使用for update 开启排他锁，以保证一个时间内，只有一个线程可以参与库存扣减</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\"># 事务开始，会开启排它锁\nstart transaction;\nselect stock from stock_info where commodity_id = 1 and seckill_id = 1 for update;\nupdate stock_info set stock = stock - 1 where commodity_id = 1 and seckill_id = 1 and \ncommit;\n</code></pre>\n<p updated=\"20220722161128\">　　或者，使用乐观锁，只能够在库存数量大于0的的情况下，才能够执行库存的扣减</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\">select stock from stock_info where commodity_id = 1 and seckill_id = 1 for update;\nupdate stock_info set stock = stock - 1 where commodity_id = 1 and seckill_id = 1 and stock &gt; 0;\n</code></pre>\n<h2 id=\"应对高QPS\">应对高QPS</h2>\n<p updated=\"20220722161128\">　　我们可以直接利用MySQL自己的特性去解决超卖问题，但是单纯的使用MySQL在并发量上来之后会直接导致MySQL崩溃。</p>\n<blockquote updated=\"20220722161128\">\n<p updated=\"20220722161128\">MySQl的QPS单点1000QPS，秒杀场景下MySQL崩溃，且秒杀场景下大部分请求无效，无需下沉到MySQL。</p>\n</blockquote>\n<p updated=\"20220722161128\">　　因此需要更加高效的中间件来做这部分服务，将无效的请求拦截到上游，我们可以采用Redis，单机Redis能达到 10万QPS。</p>\n<p updated=\"20220722161128\">　　将库存信息放到Redis中，在Redis中做库存的校验。在活动上线之前，在Redis中提前做库存的预热，查询、校验、扣减先在Redis中处理好之后，再丢到MySQL进行处理。</p>\n<p updated=\"20220722161128\">　　在活动开始之前，从数据库读取秒杀活动，然后用下面的命令将商品库存预热到redis中</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\"># 设置秒杀ID为1，商品ID为1的库存数量，只有100个\nSET seckill:1:commodity:1:stock 100\n</code></pre>\n<p updated=\"20220722161128\">　　然后，在用户请求过来的时候，用Redis拦截大量无效请求，通过Redis扣减库存之后在下方到MySQL中</p>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220628132949.png\" alt=\"\" /></span></p>\n<h2 id=\"Redis的缺陷优化\">Redis的缺陷优化</h2>\n<p updated=\"20220722161128\">　　并发量超高，同时数百万请求同时到达Redis的库存检测逻辑，Redis全部放行，这时候Redis基本无作用。</p>\n<p updated=\"20220722161128\">　　可以用Lua脚本将读取库存和库存扣减合并成一个操作来进行执行。</p>\n<pre class=\"code-block\" data-language=\"lua\"><code class=\"hljs\">local key=KEYS[1];\nlocal subNum = tonumber(ARGV[1]) ;\nlocal surplusStock = tonumber(redis.call('get',key));\nif (surplusStock&lt;=0) then return 0\nelseif (subNum &gt; surplusStock) then  return 1\nelse\n    redis.call('incrby', KEYS[1], -subNum)\n    return 2 \nend\n</code></pre>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220628134626.png\" alt=\"\" /></span></p>\n<p updated=\"20220722161128\">　　这种系统已经可以应对绝大多数的情况了</p>\n<h2 id=\"这样就完美了吗-\">这样就完美了吗？</h2>\n<p updated=\"20220722161128\">　　如果我们要秒杀的商品数据量在10W，这样下城到MySQL的量依旧非常巨大，无法承受。</p>\n<p updated=\"20220722161128\">　　所以在库存扣减之后，到MySQL的请求慢一点，可以通过MQ来进行削峰</p>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220628135500.png\" alt=\"\" /></span></p>\n<h2 id=\"分布式事务\">分布式事务</h2>\n<p updated=\"20220722161128\">　　由于采用的是微服务来进行开发，一个成功的订单需要历经各种服务。</p>\n<div data-content=\"sequenceDiagram\n    participant 付款\n    participant 支付服务\n    participant 订单服务\n    participant 商品服务\n    付款-&amp;gt;&amp;gt;支付服务:支付记录\n    支付服务-&amp;gt;&amp;gt;订单服务:更新订单状态成功付款\n    订单服务-&amp;gt;&amp;gt;商品服务:扣减库存\" data-subtype=\"mermaid\"><div spin=\"1\"></div></div>\n<p updated=\"20220722161128\">　　所以需要分布式事务来对数据一致性，进行处理。关于分布式事务，看<a href=\"/topic/分布式解决方案/数据调度/分布式事务/事务分类\">这里</a></p>\n<h2 id=\"其他的小细节\">其他的小细节</h2>\n<h3 id=\"防止刷爆商品页面\">防止刷爆商品页面</h3>\n<p updated=\"20220722161128\">　　CDN -&gt; 前端资源静态化</p>\n<h3 id=\"服务高可用\">服务高可用</h3>\n<p updated=\"20220722161128\">　　尽量不要影响其他服务，尤其是非秒杀产品的正常购买。</p>\n<h3 id=\"防止恶意刷请求或者爬虫请求\">防止恶意刷请求或者爬虫请求</h3>\n<p updated=\"20220722161128\">　　使用限流机制、验证码机制、或者接入三方风控等。</p>\n","articleNode":{"field":{"contentType":"topic","topic":"系统设计"},"frontmatter":{"id":"/topic/系统设计/样例/秒杀","title":"秒杀","date":"2022-06-16 20:21","absolute_path":"/topic/系统设计/样例/秒杀"},"htmlAst":{"type":"root","children":[{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"秒杀的三个特点:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"整点开始"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"数量有限"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"售完截止"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Scenario场景"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　QPS预测:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"平日每秒1K人访问该页面"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"秒杀每秒数十万人访问该页面"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"QPS增加100倍"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　商品购买和下单流程:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220623165604.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　秒杀情况下最大的几个难点："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"瞬时大流量高并发"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"服务器、数据库承载的QPS有限，如数据库一般是1000QPS。要根据业务预估并发量，临时扩容"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"平常qps就大几百，秒杀情况下，并发量是数十倍"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"有限库存，不能超卖"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"需要精准控制库存量，保证数据一致性（面试热点）"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"恶意请求"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"脚本模拟购买，模拟几十万请求去抢购"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"固定时间开启"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"时间到了才能买，以为服务器时间为准，NTP同步？"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"严格限购"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"用户只能买1个或N个"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"需求拆解"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　商家侧"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"新建秒杀活动"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"配置秒杀活动"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　用户侧"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"商品秒杀页面"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"购买"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"下单"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"付款"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Service 服务"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　采用微服务架构来对系统进行开发，单独抽取秒杀模块以为防止雪崩。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　关于单体架构和微服务的架构可以看"},{"type":"element","tagName":"a","properties":{"href":"../../%E6%A6%82%E5%BF%B5"},"children":[{"type":"text","value":"这里"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220623171802.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Storage存储"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　数据如何存储和访问"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"为每个Service选择存储结构"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"细化表结构"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"商品信息表 commodity_info"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品名称"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品描述"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"价格"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"desc"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"price"},{"type":"element","tagName":"br","properties":{},"children":[]}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"MBP"},{"type":"element","tagName":"br","properties":{},"children":[]}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"好用"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"25000"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"秒杀活动表 seckill_info"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"秒杀ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"秒杀名称"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"价格"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"数量"},{"type":"element","tagName":"br","properties":{},"children":[]}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"commodity_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"price"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"number"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"MBP秒杀"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"20000"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"100"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"库存信息表 stock_info"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"库存ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"秒杀ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"库存"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"锁定"},{"type":"element","tagName":"br","properties":{},"children":[]}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"commodity_id"},{"type":"element","tagName":"br","properties":{},"children":[]}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"seckill_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"stock"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"lock"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"189"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"10000"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"0"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"189"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"100"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"5"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"订单信息表 order_info"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"订单ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"商品ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"活动ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"用户ID"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"是否付款"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"commodity_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"seckill_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"user_id"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"is_pay"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"tianzeng"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"数据流向"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220624160023.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　秒杀操作:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"查询库存余量"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"0"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"select"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"from"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]}]}]}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"扣减库存"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"1"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"set"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock = stock - "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]}]}]}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"Scala扩展设计"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　秒杀本身是一个非常简单的服务，不简单的是可优化的点非常的多。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"数据一致性"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　我们上文直接采用MySQL，来应对查询，校验，扣减这一系列操作。但是这种粗暴的处理方式，在并发场景下会有超卖的问题。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　假如有两个线程进来，在第一步的时候都查询了库存，都认为当前线程持有库存。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　于是在扣减库存的时候，会把库存库存减少两次，会造成数据库中的数据和预期的不一致。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　这种情况，我们可以开启事务进行处理, 在查询的时候使用for update 开启排他锁，以保证一个时间内，只有一个线程可以参与库存扣减"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"2"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"# 事务开始，会开启排它锁"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"start"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"transaction"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"select"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"from"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" for "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"set"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock = stock - "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"commit"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　或者，使用乐观锁，只能够在库存数量大于0的的情况下，才能够执行库存的扣减"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"3"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"select"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"from"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" for "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"update"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock_info "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"set"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock = stock - "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"where"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" commodity_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill_id = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"and"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" stock > "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":";"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"应对高QPS"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　我们可以直接利用MySQL自己的特性去解决超卖问题，但是单纯的使用MySQL在并发量上来之后会直接导致MySQL崩溃。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"MySQl的QPS单点1000QPS，秒杀场景下MySQL崩溃，且秒杀场景下大部分请求无效，无需下沉到MySQL。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　因此需要更加高效的中间件来做这部分服务，将无效的请求拦截到上游，我们可以采用Redis，单机Redis能达到 10万QPS。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　将库存信息放到Redis中，在Redis中做库存的校验。在活动上线之前，在Redis中提前做库存的预热，查询、校验、扣减先在Redis中处理好之后，再丢到MySQL进行处理。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　在活动开始之前，从数据库读取秒杀活动，然后用下面的命令将商品库存预热到redis中"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"sql","dataIndex":"4"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"# 设置秒杀ID为1，商品ID为1的库存数量，只有100个"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk4"]},"children":[{"type":"text","value":"SET"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" seckill:"}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":":commodity:"}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":":stock "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"100"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　然后，在用户请求过来的时候，用Redis拦截大量无效请求，通过Redis扣减库存之后在下方到MySQL中"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220628132949.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Redis的缺陷优化"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　并发量超高，同时数百万请求同时到达Redis的库存检测逻辑，Redis全部放行，这时候Redis基本无作用。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　可以用Lua脚本将读取库存和库存扣减合并成一个操作来进行执行。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{"className":["grvsc-container","dark-default-dark"],"dataLanguage":"lua","dataIndex":"5"},"children":[{"type":"element","tagName":"code","properties":{"className":["grvsc-code"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"local"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" key=KEYS["}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"];"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"local"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" subNum = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"tonumber"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(ARGV["}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"]) ;"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"local"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" surplusStock = "}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"tonumber"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"(redis."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"call"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["mtk8"]},"children":[{"type":"text","value":"'get'"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":",key));"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"if"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" (surplusStock<="}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":") "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"then"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"0"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"elseif"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" (subNum > surplusStock) "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"then"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"  "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"else"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    redis."}]},{"type":"element","tagName":"span","properties":{"className":["mtk11"]},"children":[{"type":"text","value":"call"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["mtk8"]},"children":[{"type":"text","value":"'incrby'"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":", KEYS["}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"1"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"], -subNum)"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":"    "}]},{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"return"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]},{"type":"element","tagName":"span","properties":{"className":["mtk7"]},"children":[{"type":"text","value":"2"}]},{"type":"element","tagName":"span","properties":{"className":["mtk1"]},"children":[{"type":"text","value":" "}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["grvsc-line"]},"children":[{"type":"element","tagName":"span","properties":{"className":["grvsc-source"]},"children":[{"type":"element","tagName":"span","properties":{"className":["mtk15"]},"children":[{"type":"text","value":"end"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220628134626.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　这种系统已经可以应对绝大多数的情况了"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"这样就完美了吗？"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　如果我们要秒杀的商品数据量在10W，这样下城到MySQL的量依旧非常巨大，无法承受。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　所以在库存扣减之后，到MySQL的请求慢一点，可以通过MQ来进行削峰"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"},{"type":"element","tagName":"img","properties":{"src":"https://image.ztianzeng.com/uPic/20220628135500.png","alt":""},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"分布式事务"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　由于采用的是微服务来进行开发，一个成功的订单需要历经各种服务。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["mermaid"],"dataProcessed":"true"},"children":[{"type":"element","tagName":"svg","properties":{"id":"mermaid-1658477524577","width":"100%","xmlns":"http://www.w3.org/2000/svg","height":"315","style":"max-width: 880px;","viewBox":"-50 -10 880 315"},"children":[{"type":"element","tagName":"style","properties":{},"children":[{"type":"text","value":"#mermaid-1658477524577 {font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1658477524577 .error-icon{fill:#552222;}#mermaid-1658477524577 .error-text{fill:#552222;stroke:#552222;}#mermaid-1658477524577 .edge-thickness-normal{stroke-width:2px;}#mermaid-1658477524577 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1658477524577 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1658477524577 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1658477524577 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1658477524577 .marker{fill:#333333;stroke:#333333;}#mermaid-1658477524577 .marker.cross{stroke:#333333;}#mermaid-1658477524577 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-1658477524577 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-1658477524577 text.actor>tspan{fill:black;stroke:none;}#mermaid-1658477524577 .actor-line{stroke:grey;}#mermaid-1658477524577 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-1658477524577 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-1658477524577 #arrowhead path{fill:#333;stroke:#333;}#mermaid-1658477524577 .sequenceNumber{fill:white;}#mermaid-1658477524577 #sequencenumber{fill:#333;}#mermaid-1658477524577 #crosshead path{fill:#333;stroke:#333;}#mermaid-1658477524577 .messageText{fill:#333;stroke:#333;}#mermaid-1658477524577 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-1658477524577 .labelText,#mermaid-1658477524577 .labelText>tspan{fill:black;stroke:none;}#mermaid-1658477524577 .loopText,#mermaid-1658477524577 .loopText>tspan{fill:black;stroke:none;}#mermaid-1658477524577 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-1658477524577 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-1658477524577 .noteText,#mermaid-1658477524577 .noteText>tspan{fill:black;stroke:none;}#mermaid-1658477524577 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-1658477524577 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-1658477524577 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-1658477524577 .actorPopupMenu{position:absolute;}#mermaid-1658477524577 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-1658477524577 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-1658477524577 .actor-man circle,#mermaid-1658477524577 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-1658477524577 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}"}]},{"type":"element","tagName":"g","properties":{},"children":[]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"symbol","properties":{"id":"computer","width":"24","height":"24"},"children":[{"type":"element","tagName":"path","properties":{"transform":"scale(.5)","d":"M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"symbol","properties":{"id":"database","fillRule":"evenodd","clipRule":"evenodd"},"children":[{"type":"element","tagName":"path","properties":{"transform":"scale(.5)","d":"M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"symbol","properties":{"id":"clock","width":"24","height":"24"},"children":[{"type":"element","tagName":"path","properties":{"transform":"scale(.5)","d":"M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z"},"children":[]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"line","properties":{"id":"actor0","x1":"75","y1":"5","x2":"75","y2":"249","className":["200"],"strokeWidth":"0.5px","stroke":"#999"},"children":[]},{"type":"element","tagName":"g","properties":{"id":"root-0"},"children":[{"type":"element","tagName":"rect","properties":{"x":"0","y":"0","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"75","y":"32.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"75","dy":"0"},"children":[{"type":"text","value":"付款"}]}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"line","properties":{"id":"actor1","x1":"275","y1":"5","x2":"275","y2":"249","className":["200"],"strokeWidth":"0.5px","stroke":"#999"},"children":[]},{"type":"element","tagName":"g","properties":{"id":"root-1"},"children":[{"type":"element","tagName":"rect","properties":{"x":"200","y":"0","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"275","y":"32.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"275","dy":"0"},"children":[{"type":"text","value":"支付服务"}]}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"line","properties":{"id":"actor2","x1":"505","y1":"5","x2":"505","y2":"249","className":["200"],"strokeWidth":"0.5px","stroke":"#999"},"children":[]},{"type":"element","tagName":"g","properties":{"id":"root-2"},"children":[{"type":"element","tagName":"rect","properties":{"x":"430","y":"0","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"505","y":"32.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"505","dy":"0"},"children":[{"type":"text","value":"订单服务"}]}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"line","properties":{"id":"actor3","x1":"705","y1":"5","x2":"705","y2":"249","className":["200"],"strokeWidth":"0.5px","stroke":"#999"},"children":[]},{"type":"element","tagName":"g","properties":{"id":"root-3"},"children":[{"type":"element","tagName":"rect","properties":{"x":"630","y":"0","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"705","y":"32.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"705","dy":"0"},"children":[{"type":"text","value":"商品服务"}]}]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"marker","properties":{"id":"arrowhead","refX":"9","refY":"5","markerUnits":"userSpaceOnUse","markerWidth":"12","markerHeight":"12","orient":"auto"},"children":[{"type":"element","tagName":"path","properties":{"d":"M 0 0 L 10 5 L 0 10 z"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"marker","properties":{"id":"crosshead","markerWidth":"15","markerHeight":"8","orient":"auto","refX":"16","refY":"4"},"children":[{"type":"element","tagName":"path","properties":{"fill":"black","stroke":"#000000","strokeWidth":"1px","d":"M 9,2 V 6 L16,4 Z","style":"stroke-dasharray: 0, 0;"},"children":[]},{"type":"element","tagName":"path","properties":{"fill":"none","stroke":"#000000","strokeWidth":"1px","d":"M 0,1 L 6,7 M 6,1 L 0,7","style":"stroke-dasharray: 0, 0;"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"marker","properties":{"id":"filled-head","refX":"18","refY":"7","markerWidth":"20","markerHeight":"28","orient":"auto"},"children":[{"type":"element","tagName":"path","properties":{"d":"M 18,7 L9,13 L14,7 L9,1 Z"},"children":[]}]}]},{"type":"element","tagName":"defs","properties":{},"children":[{"type":"element","tagName":"marker","properties":{"id":"sequencenumber","refX":"15","refY":"15","markerWidth":"60","markerHeight":"40","orient":"auto"},"children":[{"type":"element","tagName":"circle","properties":{"cx":"15","cy":"15","r":"6"},"children":[]}]}]},{"type":"element","tagName":"text","properties":{"x":"175","y":"80","textAnchor":"middle","dominantBaseline":"middle","alignmentBaseline":"middle","className":["messageText"],"dy":"1em","style":"font-family: \"trebuchet ms\", verdana, arial, sans-serif; font-size: 16px; font-weight: 400;"},"children":[{"type":"text","value":"支付记录"}]},{"type":"element","tagName":"line","properties":{"x1":"75","y1":"113","x2":"275","y2":"113","className":["messageLine0"],"strokeWidth":"2","stroke":"none","markerEnd":"url(#arrowhead)","style":"fill: none;"},"children":[]},{"type":"element","tagName":"text","properties":{"x":"390","y":"128","textAnchor":"middle","dominantBaseline":"middle","alignmentBaseline":"middle","className":["messageText"],"dy":"1em","style":"font-family: \"trebuchet ms\", verdana, arial, sans-serif; font-size: 16px; font-weight: 400;"},"children":[{"type":"text","value":"更新订单状态成功付款"}]},{"type":"element","tagName":"line","properties":{"x1":"275","y1":"161","x2":"505","y2":"161","className":["messageLine0"],"strokeWidth":"2","stroke":"none","markerEnd":"url(#arrowhead)","style":"fill: none;"},"children":[]},{"type":"element","tagName":"text","properties":{"x":"605","y":"176","textAnchor":"middle","dominantBaseline":"middle","alignmentBaseline":"middle","className":["messageText"],"dy":"1em","style":"font-family: \"trebuchet ms\", verdana, arial, sans-serif; font-size: 16px; font-weight: 400;"},"children":[{"type":"text","value":"扣减库存"}]},{"type":"element","tagName":"line","properties":{"x1":"505","y1":"209","x2":"705","y2":"209","className":["messageLine0"],"strokeWidth":"2","stroke":"none","markerEnd":"url(#arrowhead)","style":"fill: none;"},"children":[]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"rect","properties":{"x":"0","y":"229","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"75","y":"261.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"75","dy":"0"},"children":[{"type":"text","value":"付款"}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"rect","properties":{"x":"200","y":"229","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"275","y":"261.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"275","dy":"0"},"children":[{"type":"text","value":"支付服务"}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"rect","properties":{"x":"430","y":"229","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"505","y":"261.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"505","dy":"0"},"children":[{"type":"text","value":"订单服务"}]}]}]},{"type":"element","tagName":"g","properties":{},"children":[{"type":"element","tagName":"rect","properties":{"x":"630","y":"229","fill":"#eaeaea","stroke":"#666","width":"150","height":"65","rx":"3","ry":"3","className":["actor"]},"children":[]},{"type":"element","tagName":"text","properties":{"x":"705","y":"261.5","dominantBaseline":"central","alignmentBaseline":"central","className":["actor"],"style":"text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, \"sans-serif\";"},"children":[{"type":"element","tagName":"tspan","properties":{"x":"705","dy":"0"},"children":[{"type":"text","value":"商品服务"}]}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　所以需要分布式事务来对数据一致性，进行处理。关于分布式事务，看"},{"type":"element","tagName":"a","properties":{"href":"/topic/%E5%88%86%E5%B8%83%E5%BC%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E6%95%B0%E6%8D%AE%E8%B0%83%E5%BA%A6/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E4%BA%8B%E5%8A%A1%E5%88%86%E7%B1%BB"},"children":[{"type":"text","value":"这里"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"其他的小细节"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"防止刷爆商品页面"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　CDN -> 前端资源静态化"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"服务高可用"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　尽量不要影响其他服务，尤其是非秒杀产品的正常购买。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"防止恶意刷请求或者爬虫请求"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　使用限流机制、验证码机制、或者接入三方风控等。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"　　"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"style","properties":{"className":["grvsc-styles"]},"children":[{"type":"text","value":"\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n"}]}],"data":{"quirksMode":false}},"html":"<blockquote updated=\"20220722161128\">\n<p updated=\"20220722161128\">秒杀的三个特点:</p>\n<p updated=\"20220722161128\">整点开始</p>\n<p updated=\"20220722161128\">数量有限</p>\n<p updated=\"20220722161128\">售完截止</p>\n</blockquote>\n<h1 id=\"Scenario场景\">Scenario场景</h1>\n<p updated=\"20220722161128\">　　QPS预测:</p>\n<ol updated=\"20220722161128\">\n<li id=\"20220722161128-7klqam4\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">平日每秒1K人访问该页面</p>\n</li>\n<li id=\"20220722161128-f45s06a\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">秒杀每秒数十万人访问该页面</p>\n</li>\n<li id=\"20220722161128-qrgev64\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">QPS增加100倍</p>\n</li>\n</ol>\n<p updated=\"20220722161128\">　　商品购买和下单流程:</p>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220623165604.png\" alt=\"\" /></span></p>\n<p updated=\"20220722161128\">　　秒杀情况下最大的几个难点：</p>\n<ol updated=\"20220722161128\">\n<li id=\"20220722161128-9lrynw1\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">瞬时大流量高并发</p>\n<p updated=\"20220722161128\">服务器、数据库承载的QPS有限，如数据库一般是1000QPS。要根据业务预估并发量，临时扩容</p>\n<p updated=\"20220722161128\">平常qps就大几百，秒杀情况下，并发量是数十倍</p>\n</li>\n<li id=\"20220722161128-c3md19l\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">有限库存，不能超卖</p>\n<p updated=\"20220722161128\">需要精准控制库存量，保证数据一致性（面试热点）</p>\n</li>\n<li id=\"20220722161128-bur6wc7\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">恶意请求</p>\n<p updated=\"20220722161128\">脚本模拟购买，模拟几十万请求去抢购</p>\n</li>\n<li id=\"20220722161128-8lru67i\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">固定时间开启</p>\n<p updated=\"20220722161128\">时间到了才能买，以为服务器时间为准，NTP同步？</p>\n</li>\n<li id=\"20220722161128-x29fyp5\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">严格限购</p>\n<p updated=\"20220722161128\">用户只能买1个或N个</p>\n</li>\n</ol>\n<h2 id=\"需求拆解\">需求拆解</h2>\n<p updated=\"20220722161128\">　　商家侧</p>\n<ul updated=\"20220722161128\">\n<li id=\"20220722161128-el1zld7\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">新建秒杀活动</p>\n</li>\n<li id=\"20220722161128-usb4ut7\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">配置秒杀活动</p>\n</li>\n</ul>\n<p updated=\"20220722161128\">　　用户侧</p>\n<ul updated=\"20220722161128\">\n<li id=\"20220722161128-480irts\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">商品秒杀页面</p>\n</li>\n<li id=\"20220722161128-qf6p6p0\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">购买</p>\n</li>\n<li id=\"20220722161128-3hswpt2\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">下单</p>\n</li>\n<li id=\"20220722161128-of9tth0\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">付款</p>\n</li>\n</ul>\n<h1 id=\"Service-服务\">Service 服务</h1>\n<p updated=\"20220722161128\">　　采用微服务架构来对系统进行开发，单独抽取秒杀模块以为防止雪崩。</p>\n<p updated=\"20220722161128\">　　关于单体架构和微服务的架构可以看<a href=\"../../概念\">这里</a></p>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220623171802.png\" alt=\"\" /></span></p>\n<h1 id=\"Storage存储\">Storage存储</h1>\n<p updated=\"20220722161128\">　　数据如何存储和访问</p>\n<ol updated=\"20220722161128\">\n<li id=\"20220722161128-intijhm\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">为每个Service选择存储结构</p>\n</li>\n<li id=\"20220722161128-w64vmzl\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">细化表结构</p>\n</li>\n</ol>\n<h3 id=\"商品信息表-commodity-info\">商品信息表 commodity_info</h3>\n<table updated=\"20220722161128\">\n<thead>\n<tr>\n<th>商品ID</th>\n<th>商品名称</th>\n<th>商品描述</th>\n<th>价格</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>name</td>\n<td>desc</td>\n<td>price<br /></td>\n</tr>\n<tr>\n<td>1</td>\n<td>MBP<br /></td>\n<td>好用</td>\n<td>25000</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"秒杀活动表-seckill-info\">秒杀活动表 seckill_info</h3>\n<table updated=\"20220722161128\">\n<thead>\n<tr>\n<th>秒杀ID</th>\n<th>秒杀名称</th>\n<th>商品ID</th>\n<th>价格</th>\n<th>数量<br /></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>name</td>\n<td>commodity_id</td>\n<td>price</td>\n<td>number</td>\n</tr>\n<tr>\n<td>1</td>\n<td>MBP秒杀</td>\n<td>1</td>\n<td>20000</td>\n<td>100</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"库存信息表-stock-info\">库存信息表 stock_info</h3>\n<table updated=\"20220722161128\">\n<thead>\n<tr>\n<th>库存ID</th>\n<th>商品ID</th>\n<th>秒杀ID</th>\n<th>库存</th>\n<th>锁定<br /></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>commodity_id<br /></td>\n<td>seckill_id</td>\n<td>stock</td>\n<td>lock</td>\n</tr>\n<tr>\n<td>1</td>\n<td>189</td>\n<td>0</td>\n<td>10000</td>\n<td>0</td>\n</tr>\n<tr>\n<td>2</td>\n<td>189</td>\n<td>1</td>\n<td>100</td>\n<td>5</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"订单信息表-order-info\">订单信息表 order_info</h3>\n<table updated=\"20220722161128\">\n<thead>\n<tr>\n<th>订单ID</th>\n<th>商品ID</th>\n<th>活动ID</th>\n<th>用户ID</th>\n<th>是否付款</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>commodity_id</td>\n<td>seckill_id</td>\n<td>user_id</td>\n<td>is_pay</td>\n</tr>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>1</td>\n<td>tianzeng</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"数据流向\">数据流向</h2>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220624160023.png\" alt=\"\" /></span></p>\n<p updated=\"20220722161128\">　　秒杀操作:</p>\n<ol updated=\"20220722161128\">\n<li id=\"20220722161128-bzmdwm3\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">查询库存余量</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\">select stock from stock_info where commodity_id = 1 and seckill_id = 1\n</code></pre></li>\n<li id=\"20220722161128-7xzd8py\" updated=\"20220722161128\">\n<p updated=\"20220722161128\">扣减库存</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\">update stock_info set stock = stock - 1 where commodity_id = 1 and seckill_id = 1\n</code></pre></li>\n</ol>\n<h1 id=\"Scala扩展设计\">Scala扩展设计</h1>\n<p updated=\"20220722161128\">　　秒杀本身是一个非常简单的服务，不简单的是可优化的点非常的多。</p>\n<h2 id=\"数据一致性\">数据一致性</h2>\n<p updated=\"20220722161128\">　　我们上文直接采用MySQL，来应对查询，校验，扣减这一系列操作。但是这种粗暴的处理方式，在并发场景下会有超卖的问题。</p>\n<p updated=\"20220722161128\">　　假如有两个线程进来，在第一步的时候都查询了库存，都认为当前线程持有库存。</p>\n<p updated=\"20220722161128\">　　于是在扣减库存的时候，会把库存库存减少两次，会造成数据库中的数据和预期的不一致。</p>\n<p updated=\"20220722161128\">　　这种情况，我们可以开启事务进行处理, 在查询的时候使用for update 开启排他锁，以保证一个时间内，只有一个线程可以参与库存扣减</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\"># 事务开始，会开启排它锁\nstart transaction;\nselect stock from stock_info where commodity_id = 1 and seckill_id = 1 for update;\nupdate stock_info set stock = stock - 1 where commodity_id = 1 and seckill_id = 1 and \ncommit;\n</code></pre>\n<p updated=\"20220722161128\">　　或者，使用乐观锁，只能够在库存数量大于0的的情况下，才能够执行库存的扣减</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\">select stock from stock_info where commodity_id = 1 and seckill_id = 1 for update;\nupdate stock_info set stock = stock - 1 where commodity_id = 1 and seckill_id = 1 and stock &gt; 0;\n</code></pre>\n<h2 id=\"应对高QPS\">应对高QPS</h2>\n<p updated=\"20220722161128\">　　我们可以直接利用MySQL自己的特性去解决超卖问题，但是单纯的使用MySQL在并发量上来之后会直接导致MySQL崩溃。</p>\n<blockquote updated=\"20220722161128\">\n<p updated=\"20220722161128\">MySQl的QPS单点1000QPS，秒杀场景下MySQL崩溃，且秒杀场景下大部分请求无效，无需下沉到MySQL。</p>\n</blockquote>\n<p updated=\"20220722161128\">　　因此需要更加高效的中间件来做这部分服务，将无效的请求拦截到上游，我们可以采用Redis，单机Redis能达到 10万QPS。</p>\n<p updated=\"20220722161128\">　　将库存信息放到Redis中，在Redis中做库存的校验。在活动上线之前，在Redis中提前做库存的预热，查询、校验、扣减先在Redis中处理好之后，再丢到MySQL进行处理。</p>\n<p updated=\"20220722161128\">　　在活动开始之前，从数据库读取秒杀活动，然后用下面的命令将商品库存预热到redis中</p>\n<pre class=\"code-block\" data-language=\"sql\"><code class=\"hljs\"># 设置秒杀ID为1，商品ID为1的库存数量，只有100个\nSET seckill:1:commodity:1:stock 100\n</code></pre>\n<p updated=\"20220722161128\">　　然后，在用户请求过来的时候，用Redis拦截大量无效请求，通过Redis扣减库存之后在下方到MySQL中</p>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220628132949.png\" alt=\"\" /></span></p>\n<h2 id=\"Redis的缺陷优化\">Redis的缺陷优化</h2>\n<p updated=\"20220722161128\">　　并发量超高，同时数百万请求同时到达Redis的库存检测逻辑，Redis全部放行，这时候Redis基本无作用。</p>\n<p updated=\"20220722161128\">　　可以用Lua脚本将读取库存和库存扣减合并成一个操作来进行执行。</p>\n<pre class=\"code-block\" data-language=\"lua\"><code class=\"hljs\">local key=KEYS[1];\nlocal subNum = tonumber(ARGV[1]) ;\nlocal surplusStock = tonumber(redis.call('get',key));\nif (surplusStock&lt;=0) then return 0\nelseif (subNum &gt; surplusStock) then  return 1\nelse\n    redis.call('incrby', KEYS[1], -subNum)\n    return 2 \nend\n</code></pre>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220628134626.png\" alt=\"\" /></span></p>\n<p updated=\"20220722161128\">　　这种系统已经可以应对绝大多数的情况了</p>\n<h2 id=\"这样就完美了吗-\">这样就完美了吗？</h2>\n<p updated=\"20220722161128\">　　如果我们要秒杀的商品数据量在10W，这样下城到MySQL的量依旧非常巨大，无法承受。</p>\n<p updated=\"20220722161128\">　　所以在库存扣减之后，到MySQL的请求慢一点，可以通过MQ来进行削峰</p>\n<p updated=\"20220722161128\">　　<span class=\"img\"><img src=\"https://image.ztianzeng.com/uPic/20220628135500.png\" alt=\"\" /></span></p>\n<h2 id=\"分布式事务\">分布式事务</h2>\n<p updated=\"20220722161128\">　　由于采用的是微服务来进行开发，一个成功的订单需要历经各种服务。</p>\n<div data-content=\"sequenceDiagram\n    participant 付款\n    participant 支付服务\n    participant 订单服务\n    participant 商品服务\n    付款-&amp;gt;&amp;gt;支付服务:支付记录\n    支付服务-&amp;gt;&amp;gt;订单服务:更新订单状态成功付款\n    订单服务-&amp;gt;&amp;gt;商品服务:扣减库存\" data-subtype=\"mermaid\"><div spin=\"1\"></div></div>\n<p updated=\"20220722161128\">　　所以需要分布式事务来对数据一致性，进行处理。关于分布式事务，看<a href=\"/topic/分布式解决方案/数据调度/分布式事务/事务分类\">这里</a></p>\n<h2 id=\"其他的小细节\">其他的小细节</h2>\n<h3 id=\"防止刷爆商品页面\">防止刷爆商品页面</h3>\n<p updated=\"20220722161128\">　　CDN -&gt; 前端资源静态化</p>\n<h3 id=\"服务高可用\">服务高可用</h3>\n<p updated=\"20220722161128\">　　尽量不要影响其他服务，尤其是非秒杀产品的正常购买。</p>\n<h3 id=\"防止恶意刷请求或者爬虫请求\">防止恶意刷请求或者爬虫请求</h3>\n<p updated=\"20220722161128\">　　使用限流机制、验证码机制、或者接入三方风控等。</p>\n","headings":[{"depth":1,"value":"Scenario场景"},{"depth":2,"value":"需求拆解"},{"depth":1,"value":"Service 服务"},{"depth":1,"value":"Storage存储"},{"depth":3,"value":"商品信息表 commodity_info"},{"depth":3,"value":"秒杀活动表 seckill_info"},{"depth":3,"value":"库存信息表 stock_info"},{"depth":3,"value":"订单信息表 order_info"},{"depth":2,"value":"数据流向"},{"depth":1,"value":"Scala扩展设计"},{"depth":2,"value":"数据一致性"},{"depth":2,"value":"应对高QPS"},{"depth":2,"value":"Redis的缺陷优化"},{"depth":2,"value":"这样就完美了吗？"},{"depth":2,"value":"分布式事务"},{"depth":2,"value":"其他的小细节"},{"depth":3,"value":"防止刷爆商品页面"},{"depth":3,"value":"服务高可用"},{"depth":3,"value":"防止恶意刷请求或者爬虫请求"}],"path":"/topic/系统设计/样例/秒杀"},"tree":{"title":"系统设计","id":"20220523142842-5ohvsi1","parentId":"","href":"/topic/系统设计","path":"/topic/系统设计","children":[{"title":"概念","id":"20220615132453-664g7l0","type":"d","href":"/topic/系统设计/概念","parentId":"","path":"/topic/系统设计/概念","parentPath":"/topic/系统设计","sort":1,"children":[{"title":"数据库系统 VS 文件系统","id":"20220615102743-qj0plmz","type":"h","href":"/topic/系统设计/概念#数据库系统 VS 文件系统","parentId":"20220615132453-664g7l0","path":"/topic/系统设计/概念","parentPath":"/topic/系统设计","children":[{"title":"关系","id":"20220615102811-lmbzu19","type":"h","href":"/topic/系统设计/概念#关系","parentId":"20220615102743-qj0plmz","path":"/topic/系统设计/概念","parentPath":"/topic/系统设计","children":[],"level":3},{"title":"区别","id":"20220615102835-8kegc0y","type":"h","href":"/topic/系统设计/概念#区别","parentId":"20220615102743-qj0plmz","path":"/topic/系统设计/概念","parentPath":"/topic/系统设计","children":[],"level":3},{"title":"总结","id":"20220615103035-c70ck6k","type":"h","href":"/topic/系统设计/概念#总结","parentId":"20220615102743-qj0plmz","path":"/topic/系统设计/概念","parentPath":"/topic/系统设计","children":[],"level":3}],"level":2},{"title":"单体架构VS微服务架构","id":"20220628154518-x6kau73","type":"h","href":"/topic/系统设计/概念#单体架构VS微服务架构","parentId":"20220615132453-664g7l0","path":"/topic/系统设计/概念","parentPath":"/topic/系统设计","children":[{"title":"单体架构","id":"20220628154527-mj1noqe","type":"h","href":"/topic/系统设计/概念#单体架构","parentId":"20220628154518-x6kau73","path":"/topic/系统设计/概念","parentPath":"/topic/系统设计","children":[],"level":3},{"title":"微服务架构","id":"20220628154527-xpc8zw5","type":"h","href":"/topic/系统设计/概念#微服务架构","parentId":"20220628154518-x6kau73","path":"/topic/系统设计/概念","parentPath":"/topic/系统设计","children":[],"level":3}],"level":2}],"level":1},{"title":"4S分析法","id":"20220531175247-wjawyqd","type":"d","href":"/topic/系统设计/4S分析法","parentId":"","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","sort":2,"children":[{"title":"Scenario场景","id":"20220614162313-ymy6pxo","type":"h","href":"/topic/系统设计/4S分析法#Scenario场景","parentId":"20220531175247-wjawyqd","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[{"title":"需要设计哪些功能","id":"20220616132326-s55nquu","type":"h","href":"/topic/系统设计/4S分析法#需要设计哪些功能","parentId":"20220614162313-ymy6pxo","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":3},{"title":"需要承受的访问量","id":"20220616132326-y5xmygg","type":"h","href":"/topic/系统设计/4S分析法#需要承受的访问量","parentId":"20220614162313-ymy6pxo","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":3}],"level":2},{"title":"Service服务","id":"20220616132326-j1gz6ab","type":"h","href":"/topic/系统设计/4S分析法#Service服务","parentId":"20220531175247-wjawyqd","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":2},{"title":"Storage存储","id":"20220616132404-d4ylqml","type":"h","href":"/topic/系统设计/4S分析法#Storage存储","parentId":"20220531175247-wjawyqd","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[{"title":"处理步骤","id":"20220616132411-bvaq4hy","type":"h","href":"/topic/系统设计/4S分析法#处理步骤","parentId":"20220616132404-d4ylqml","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[{"title":"第一步：为每个Service选择存储结构","id":"20220616132411-o42gm70","type":"h","href":"/topic/系统设计/4S分析法#第一步：为每个Service选择存储结构","parentId":"20220616132411-bvaq4hy","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":4},{"title":"第二步：细化表结构","id":"20220616132411-fu7embq","type":"h","href":"/topic/系统设计/4S分析法#第二步：细化表结构","parentId":"20220616132411-bvaq4hy","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":4}],"level":3},{"title":"存储模型","id":"20220616132411-wuznh3m","type":"h","href":"/topic/系统设计/4S分析法#存储模型","parentId":"20220616132404-d4ylqml","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[{"title":"Pull Model 拉模型","id":"20220616132411-ltf0w00","type":"h","href":"/topic/系统设计/4S分析法#Pull Model 拉模型","parentId":"20220616132411-wuznh3m","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":4}],"level":3}],"level":2},{"title":"Scala扩展设计","id":"20220616132437-btg0npi","type":"h","href":"/topic/系统设计/4S分析法#Scala扩展设计","parentId":"20220531175247-wjawyqd","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[{"title":"处理步骤","id":"20220616132443-l9hc1mr","type":"h","href":"/topic/系统设计/4S分析法#处理步骤","parentId":"20220616132437-btg0npi","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[{"title":"第一步：优化","id":"20220616132443-i0no8v4","type":"h","href":"/topic/系统设计/4S分析法#第一步：优化","parentId":"20220616132443-l9hc1mr","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":4},{"title":"第二部：维护","id":"20220616132443-xo6qd61","type":"h","href":"/topic/系统设计/4S分析法#第二部：维护","parentId":"20220616132443-l9hc1mr","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":4}],"level":3},{"title":"Pull的缺陷","id":"20220616132451-87l1875","type":"h","href":"/topic/系统设计/4S分析法#Pull的缺陷","parentId":"20220616132437-btg0npi","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":3},{"title":"Push的缺陷","id":"20220616132443-bjr9ha0","type":"h","href":"/topic/系统设计/4S分析法#Push的缺陷","parentId":"20220616132437-btg0npi","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":3},{"title":"处理","id":"20220616132443-ezk0war","type":"h","href":"/topic/系统设计/4S分析法#处理","parentId":"20220616132437-btg0npi","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[{"title":"最小改动","id":"20220616132443-lmdkzs3","type":"h","href":"/topic/系统设计/4S分析法#最小改动","parentId":"20220616132443-ezk0war","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":4},{"title":"增长预估","id":"20220616132443-1x7j1ed","type":"h","href":"/topic/系统设计/4S分析法#增长预估","parentId":"20220616132443-ezk0war","path":"/topic/系统设计/4S分析法","parentPath":"/topic/系统设计","children":[],"level":4}],"level":3}],"level":2}],"level":1},{"title":"样例","id":"20220523161014-1vkr1si","type":"d","href":"/topic/系统设计/样例","parentId":"","path":"/topic/系统设计/样例","parentPath":"/topic/系统设计","sort":3,"children":[{"title":"短链系统","id":"20220523142856-tm0dduf","type":"d","href":"/topic/系统设计/样例/短链系统","parentId":"","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","sort":1,"children":[{"title":"概述用例和约束","id":"20220523152802-ora3luz","type":"h","href":"/topic/系统设计/样例/短链系统#概述用例和约束","parentId":"20220523142856-tm0dduf","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[{"title":"用例","id":"20220523153231-cqe7c6z","type":"h","href":"/topic/系统设计/样例/短链系统#用例","parentId":"20220523152802-ora3luz","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"约束和假设","id":"20220523153213-tyokdre","type":"h","href":"/topic/系统设计/样例/短链系统#约束和假设","parentId":"20220523152802-ora3luz","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"预估容量","id":"20220523153245-akx221a","type":"h","href":"/topic/系统设计/样例/短链系统#预估容量","parentId":"20220523152802-ora3luz","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":4}],"level":3},{"title":"创建一个高层次设计","id":"20220523154027-n2m6mb0","type":"h","href":"/topic/系统设计/样例/短链系统#创建一个高层次设计","parentId":"20220523142856-tm0dduf","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":3},{"title":"设计核心组件","id":"20220523155756-as6zfq4","type":"h","href":"/topic/系统设计/样例/短链系统#设计核心组件","parentId":"20220523142856-tm0dduf","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[{"title":"用例: 用户输入一段文本，然后得到一个随机生成的链接","id":"20220523155920-i5awrmn","type":"h","href":"/topic/系统设计/样例/短链系统#用例: 用户输入一段文本，然后得到一个随机生成的链接","parentId":"20220523155756-as6zfq4","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"用例：用户输入一个 paste 的 url 后可以看到它存储的内容","id":"20220523160445-ppzjfcg","type":"h","href":"/topic/系统设计/样例/短链系统#用例：用户输入一个 paste 的 url 后可以看到它存储的内容","parentId":"20220523155756-as6zfq4","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"用例： 服务跟踪分析页面","id":"20220523160523-x0zwdli","type":"h","href":"/topic/系统设计/样例/短链系统#用例： 服务跟踪分析页面","parentId":"20220523155756-as6zfq4","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"用例： 服务删除过期的 pastes","id":"20220523160541-cln3fph","type":"h","href":"/topic/系统设计/样例/短链系统#用例： 服务删除过期的 pastes","parentId":"20220523155756-as6zfq4","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":4}],"level":3},{"title":"扩展设计","id":"20220523160546-vbv6n9j","type":"h","href":"/topic/系统设计/样例/短链系统#扩展设计","parentId":"20220523142856-tm0dduf","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":3},{"title":"总结","id":"20220523163729-9u3wkrv","type":"h","href":"/topic/系统设计/样例/短链系统#总结","parentId":"20220523142856-tm0dduf","path":"/topic/系统设计/样例/短链系统","parentPath":"/topic/系统设计/样例","children":[],"level":3}],"level":2},{"title":"微博架构设计","id":"20220524140048-zkiqvui","type":"d","href":"/topic/系统设计/样例/微博架构设计","parentId":"","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","sort":2,"children":[{"title":"概述用例和约束","id":"20220524140533-yb6pk63","type":"h","href":"/topic/系统设计/样例/微博架构设计#概述用例和约束","parentId":"20220524140048-zkiqvui","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[{"title":"用例","id":"20220524140955-hl15d6z","type":"h","href":"/topic/系统设计/样例/微博架构设计#用例","parentId":"20220524140533-yb6pk63","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"限制条件与假设","id":"20220524142056-m6nm6xm","type":"h","href":"/topic/系统设计/样例/微博架构设计#限制条件与假设","parentId":"20220524140533-yb6pk63","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[],"level":4}],"level":3},{"title":"概要设计","id":"20220524145303-hrsunb1","type":"h","href":"/topic/系统设计/样例/微博架构设计#概要设计","parentId":"20220524140048-zkiqvui","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[],"level":3},{"title":"设计核心组件","id":"20220524154837-c7lw852","type":"h","href":"/topic/系统设计/样例/微博架构设计#设计核心组件","parentId":"20220524140048-zkiqvui","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[{"title":"用例: 用户发表了一篇微博","id":"20220524155958-ygnj4py","type":"h","href":"/topic/系统设计/样例/微博架构设计#用例: 用户发表了一篇微博","parentId":"20220524154837-c7lw852","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"用例：用户浏览聚合主页时间轴","id":"20220524163832-k1u2urx","type":"h","href":"/topic/系统设计/样例/微博架构设计#用例：用户浏览聚合主页时间轴","parentId":"20220524154837-c7lw852","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"用例：用户浏览用户时间轴","id":"20220524164247-audibq3","type":"h","href":"/topic/系统设计/样例/微博架构设计#用例：用户浏览用户时间轴","parentId":"20220524154837-c7lw852","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"用例：用户搜索关键词","id":"20220524164312-1obgv97","type":"h","href":"/topic/系统设计/样例/微博架构设计#用例：用户搜索关键词","parentId":"20220524154837-c7lw852","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[],"level":4}],"level":3},{"title":"架构扩展","id":"20220524164325-q9o9ung","type":"h","href":"/topic/系统设计/样例/微博架构设计#架构扩展","parentId":"20220524140048-zkiqvui","path":"/topic/系统设计/样例/微博架构设计","parentPath":"/topic/系统设计/样例","children":[],"level":3}],"level":2},{"title":"秒杀","id":"20220616202141-hy1nbif","type":"d","href":"/topic/系统设计/样例/秒杀","parentId":"","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","sort":4,"children":[{"title":"Scenario场景","id":"20220616202308-9bgzn5z","type":"h","href":"/topic/系统设计/样例/秒杀#Scenario场景","parentId":"20220616202141-hy1nbif","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[{"title":"需求拆解","id":"20220623170337-upk31iw","type":"h","href":"/topic/系统设计/样例/秒杀#需求拆解","parentId":"20220616202308-9bgzn5z","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4}],"level":3},{"title":"Service 服务","id":"20220623170617-lfeu5ob","type":"h","href":"/topic/系统设计/样例/秒杀#Service 服务","parentId":"20220616202141-hy1nbif","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":3},{"title":"Storage存储","id":"20220623210002-oh2z3zd","type":"h","href":"/topic/系统设计/样例/秒杀#Storage存储","parentId":"20220616202141-hy1nbif","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[{"title":"商品信息表 commodity_info","id":"20220624113741-lsybjg4","type":"h","href":"/topic/系统设计/样例/秒杀#商品信息表 commodity_info","parentId":"20220623210002-oh2z3zd","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"秒杀活动表 seckill_info","id":"20220624113935-pc2me4m","type":"h","href":"/topic/系统设计/样例/秒杀#秒杀活动表 seckill_info","parentId":"20220623210002-oh2z3zd","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"库存信息表 stock_info","id":"20220624131344-2oot3xz","type":"h","href":"/topic/系统设计/样例/秒杀#库存信息表 stock_info","parentId":"20220623210002-oh2z3zd","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"订单信息表 order_info","id":"20220624131601-lgvwksl","type":"h","href":"/topic/系统设计/样例/秒杀#订单信息表 order_info","parentId":"20220623210002-oh2z3zd","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"数据流向","id":"20220624131855-pzpipel","type":"h","href":"/topic/系统设计/样例/秒杀#数据流向","parentId":"20220623210002-oh2z3zd","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4}],"level":3},{"title":"Scala扩展设计","id":"20220628155648-7dj6e6e","type":"h","href":"/topic/系统设计/样例/秒杀#Scala扩展设计","parentId":"20220616202141-hy1nbif","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[{"title":"数据一致性","id":"20220628155654-6w1zago","type":"h","href":"/topic/系统设计/样例/秒杀#数据一致性","parentId":"20220628155648-7dj6e6e","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"应对高QPS","id":"20220628155339-dp92t46","type":"h","href":"/topic/系统设计/样例/秒杀#应对高QPS","parentId":"20220628155648-7dj6e6e","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"Redis的缺陷优化","id":"20220628132922-1wcck7q","type":"h","href":"/topic/系统设计/样例/秒杀#Redis的缺陷优化","parentId":"20220628155648-7dj6e6e","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"这样就完美了吗？","id":"20220628134645-m8f0zw1","type":"h","href":"/topic/系统设计/样例/秒杀#这样就完美了吗？","parentId":"20220628155648-7dj6e6e","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"分布式事务","id":"20220628135940-s7irnu6","type":"h","href":"/topic/系统设计/样例/秒杀#分布式事务","parentId":"20220628155648-7dj6e6e","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":4},{"title":"其他的小细节","id":"20220628165937-aaii6h7","type":"h","href":"/topic/系统设计/样例/秒杀#其他的小细节","parentId":"20220628155648-7dj6e6e","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[{"title":"防止刷爆商品页面","id":"20220628140318-7jb6y79","type":"h","href":"/topic/系统设计/样例/秒杀#防止刷爆商品页面","parentId":"20220628165937-aaii6h7","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":5},{"title":"服务高可用","id":"20220628140639-2r8f6ir","type":"h","href":"/topic/系统设计/样例/秒杀#服务高可用","parentId":"20220628165937-aaii6h7","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":5},{"title":"防止恶意刷请求或者爬虫请求","id":"20220628140847-bweqsx9","type":"h","href":"/topic/系统设计/样例/秒杀#防止恶意刷请求或者爬虫请求","parentId":"20220628165937-aaii6h7","path":"/topic/系统设计/样例/秒杀","parentPath":"/topic/系统设计/样例","children":[],"level":5}],"level":4}],"level":3}],"level":2}],"level":1},{"title":"Flux架构","id":"20220630203113-cjoqcbf","type":"d","href":"/topic/系统设计/Flux架构","parentId":"","path":"/topic/系统设计/Flux架构","parentPath":"/topic/系统设计","sort":5,"children":[],"level":1},{"title":"Http进化史","id":"20220701132636-sffchc7","type":"d","href":"/topic/系统设计/Http进化史","parentId":"","path":"/topic/系统设计/Http进化史","parentPath":"/topic/系统设计","children":[],"level":1},{"title":"每个程序员都应该知道的延迟数字","id":"20220524194105-29b5zns","type":"d","href":"/topic/系统设计/每个程序员都应该知道的延迟数字","parentId":"","path":"/topic/系统设计/每个程序员都应该知道的延迟数字","parentPath":"/topic/系统设计","sort":4,"children":[],"level":1}],"level":0},"headings":[{"depth":1,"value":"Scenario场景","slug":"scenario场景"},{"depth":2,"value":"需求拆解","slug":"需求拆解"},{"depth":1,"value":"Service 服务","slug":"service-服务"},{"depth":1,"value":"Storage存储","slug":"storage存储"},{"depth":3,"value":"商品信息表 commodity_info","slug":"商品信息表-commodity_info"},{"depth":3,"value":"秒杀活动表 seckill_info","slug":"秒杀活动表-seckill_info"},{"depth":3,"value":"库存信息表 stock_info","slug":"库存信息表-stock_info"},{"depth":3,"value":"订单信息表 order_info","slug":"订单信息表-order_info"},{"depth":2,"value":"数据流向","slug":"数据流向"},{"depth":1,"value":"Scala扩展设计","slug":"scala扩展设计"},{"depth":2,"value":"数据一致性","slug":"数据一致性"},{"depth":2,"value":"应对高QPS","slug":"应对高qps"},{"depth":2,"value":"Redis的缺陷优化","slug":"redis的缺陷优化"},{"depth":2,"value":"这样就完美了吗？","slug":"这样就完美了吗"},{"depth":2,"value":"分布式事务","slug":"分布式事务"},{"depth":2,"value":"其他的小细节","slug":"其他的小细节"},{"depth":3,"value":"防止刷爆商品页面","slug":"防止刷爆商品页面"},{"depth":3,"value":"服务高可用","slug":"服务高可用"},{"depth":3,"value":"防止恶意刷请求或者爬虫请求","slug":"防止恶意刷请求或者爬虫请求"}]}},
    "staticQueryHashes": ["630634786","928362550"]}